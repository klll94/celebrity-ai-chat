<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>名人智能体对话</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 430px;
            width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            background: transparent;
            position: relative;
        }

        /* 首页样式 - 更清新的设计 */
        .home-page {
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: transparent;
        }

        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .app-title {
            font-size: 2.4rem;
            font-weight: 300;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .app-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .celebrities-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            width: 100%;
            margin: 0 auto;
            flex: 1;
        }

        .celebrity-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 18px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 200ms ease;
            backdrop-filter: blur(10px);
        }

        .celebrity-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0,0,0,0.15);
            background: rgba(255, 255, 255, 1);
        }

        .celebrity-avatar {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            display: block;
            margin: 0 auto 12px;
        }

        .celebrity-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 6px;
        }

        .celebrity-period {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .celebrity-desc {
            font-size: 0.88rem;
            color: #666;
            line-height: 1.5;
        }

        /* 聊天页面样式 */
        .chat-page {
            display: none;
            height: 100vh;
            position: relative;
            background: #f8f9fa;
        }

        .chat-page.show {
            display: block;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e5e5e5;
            position: relative;
            z-index: 10;
        }

        .back-btn {
            display: flex;
            align-items: center;
            color: #667eea;
            text-decoration: none;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .back-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .char-info {
            display: flex;
            align-items: center;
            flex: 1;
            justify-content: center;
            gap: 12px;
        }

        .char-avatar-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e5e5;
        }

        .char-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .char-period {
            font-size: 0.85rem;
            color: #888;
            margin: 0;
        }

        .coze-chat-container {
            position: absolute;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
        }

        .hidden { 
            display: none; 
        }

        .show { 
            display: block; 
        }

        /* 加载动画 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        /* 响应式调整 */
        @media (max-width: 480px) {
            .app-title {
                font-size: 2rem;
            }
            
            .celebrity-avatar {
                width: 68px;
                height: 68px;
            }
            
            .celebrity-card {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 首页 - 移除了开发者按钮，界面更清新 -->
        <div id="home-page" class="home-page">
            <div class="app-header">
                <div class="header-content">
                    <h1 class="app-title">名人智能体对话</h1>
                    <p class="app-subtitle">与历史名人进行智能对话，探索知识的海洋</p>
                </div>
            </div>

            <div class="celebrities-section">
                <div id="celebrities-grid" class="celebrities-grid">
                    <!-- 角色卡片将通过JS动态生成 -->
                </div>
            </div>
        </div>

        <!-- 聊天页面 -->
        <div id="chat-page" class="chat-page">
            <div class="chat-header">
                <button id="back-btn" class="back-btn">
                    <span>←</span>
                    <span style="margin-left: 8px;">返回</span>
                </button>
                
                <div class="char-info">
                    <img id="current-char-avatar" class="char-avatar-img" src="" alt="角色头像">
                    <div class="char-details">
                        <div id="current-char-name" class="char-name">加载中...</div>
                        <div id="current-char-period" class="char-period"></div>
                    </div>
                </div>
                
                <div style="min-width: 80px;"></div>
            </div>
            
            <div id="coze-chat-container" class="coze-chat-container">
                <!-- Coze Chat 将在这里渲染 -->
            </div>
        </div>
    </div>

    <script>
        console.log('开始加载名人智能体对话应用...');

        // 18个名人数据配置
        const CELEBRITIES_DATA = [
            {
                id: 'libai',
                name: '李白',
                period: '唐朝 (701-762)',
                description: '唐代浪漫主义诗人，被誉为"诗仙"',
                avatar: 'images/李白.png',
                botId: 'YOUR_LIBAI_BOT_ID',
                presetQuestions: [
                    '李白叔叔，你能教我写一首简单的诗吗？',
                    '你为什么这么喜欢月亮和酒呢？'
                ]
            },
            {
                id: 'luxun',
                name: '鲁迅',
                period: '近现代 (1881-1936)',
                description: '中国现代文学奠基人、思想家、文学家、革命家',
                avatar: 'images/鲁迅.png',
                botId: 'YOUR_LUXUN_BOT_ID',
                presetQuestions: [
                    '鲁迅爷爷，你小时候最喜欢读什么书？',
                    '你写的《从百草园到三味书屋》里哪个故事最有趣？'
                ]
            },
            {
                id: 'edison',
                name: '爱迪生',
                period: '近现代 (1847-1931)',
                description: '美国发明家、企业家，拥有众多重要发明专利',
                avatar: 'images/爱迪生.png',
                botId: 'YOUR_EDISON_BOT_ID',
                presetQuestions: [
                    '发明电灯泡时遇到了什么困难？',
                    '你认为创新的秘诀是什么？'
                ]
            },
            {
                id: 'faraday',
                name: '法拉第',
                period: '近现代 (1791-1867)',
                description: '英国物理学家、化学家，电磁学奠基人',
                avatar: 'images/法拉第.png',
                botId: 'YOUR_FARADAY_BOT_ID',
                presetQuestions: [
                    '能解释一下电磁感应现象吗？',
                    '你是如何发现电磁定律的？'
                ]
            },
            {
                id: 'luobinwang',
                name: '骆宾王',
                period: '唐朝 (约640-684)',
                description: '唐代诗人，"初唐四杰"之一',
                avatar: 'images/骆宾王.png',
                botId: 'YOUR_LUOBINWANG_BOT_ID',
                presetQuestions: [
                    '能分享一下你的代表作品吗？',
                    '如何看待诗歌的社会作用？'
                ]
            },
            {
                id: 'wangwei',
                name: '王维',
                period: '唐朝 (701-761)',
                description: '唐代诗人、画家，山水田园诗派代表',
                avatar: 'images/王维.png',
                botId: 'YOUR_WANGWEI_BOT_ID',
                presetQuestions: [
                    '能描述一下你眼中的山水之美吗？',
                    '诗画结合的艺术境界是怎样的？'
                ]
            },
            {
                id: 'yeshengtao',
                name: '叶圣陶',
                period: '现代 (1894-1988)',
                description: '中国现代作家、教育家、出版家',
                avatar: 'images/叶圣陶.png',
                botId: 'YOUR_YESHENGTAO_BOT_ID'
            },
            {
                id: 'menghaoran',
                name: '孟浩然',
                period: '唐朝 (689-740)',
                description: '唐代诗人，山水田园诗派代表',
                avatar: 'images/孟浩然.png',
                botId: 'YOUR_MENGHAORAN_BOT_ID'
            },
            {
                id: 'baijuyi',
                name: '白居易',
                period: '唐朝 (772-846)',
                description: '唐代诗人，现实主义诗歌的倡导者',
                avatar: 'images/白居易.png',
                botId: 'YOUR_BAIJUYI_BOT_ID'
            },
            {
                id: 'yangwanli',
                name: '杨万里',
                period: '南宋 (1127-1206)',
                description: '南宋诗人，"中兴四大诗人"之一',
                avatar: 'images/杨万里.png',
                botId: 'YOUR_YANGWANLI_BOT_ID'
            },
            {
                id: 'jiadao',
                name: '贾岛',
                period: '唐朝 (779-843)',
                description: '唐代诗人，苦吟诗人的代表',
                avatar: 'images/贾岛.png',
                botId: 'YOUR_JIADAO_BOT_ID'
            },
            {
                id: 'quyuan',
                name: '屈原',
                period: '战国 (约340-278BC)',
                description: '中国古代伟大的爱国诗人，楚辞创立者',
                avatar: 'images/屈原.png',
                botId: 'YOUR_QUYUAN_BOT_ID'
            },
            {
                id: 'zhukezhen',
                name: '竺可桢',
                period: '现代 (1890-1974)',
                description: '中国现代气象学家、地理学家',
                avatar: 'images/竺可桢.png',
                botId: 'YOUR_ZHUKEZHEN_BOT_ID'
            },
            {
                id: 'shenkuo',
                name: '沈括',
                period: '北宋 (1031-1095)',
                description: '北宋科学家、政治家，《梦溪笔谈》作者',
                avatar: 'images/沈括.png',
                botId: 'YOUR_SHENKUO_BOT_ID'
            },
            {
                id: 'tuyouyou',
                name: '屠呦呦',
                period: '现代 (1930-)',
                description: '中国药学家，诺贝尔生理学或医学奖获得者',
                avatar: 'images/屠呦呦.png',
                botId: 'YOUR_TUYOUYOU_BOT_ID'
            },
            {
                id: 'newton',
                name: '牛顿',
                period: '近现代 (1643-1727)',
                description: '英国物理学家、数学家，经典力学的奠基人',
                avatar: 'images/牛顿.png',
                botId: 'YOUR_NEWTON_BOT_ID'
            },
            {
                id: 'galileo',
                name: '伽利略',
                period: '近现代 (1564-1642)',
                description: '意大利物理学家、天文学家，近代科学奠基人',
                avatar: 'images/伽利略.png',
                botId: 'YOUR_GALILEO_BOT_ID'
            },
            {
                id: 'nieer',
                name: '聂耳',
                period: '现代 (1912-1935)',
                description: '中国音乐家，《义勇军进行曲》作曲者',
                avatar: 'images/聂耳.png',
                botId: 'YOUR_NIEER_BOT_ID'
            }
        ];

        let currentChatClient = null;
        let currentCharacter = null;
        
        // 生成唯一的用户会话ID - 确保会话隔离
        function generateUserSessionId() {
            const saved = localStorage.getItem('user_session_id');
            if (saved) return saved;
            
            // 生成UUID格式的会话ID
            const sessionId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('user_session_id', sessionId);
            console.log('生成新的用户会话ID:', sessionId);
            return sessionId;
        }

        // 获取配置（从localStorage或环境变量）
        function getApiConfig() {
            // 优先从localStorage获取（开发者在后台配置的）
            const apiKey = localStorage.getItem('coze_api_key');
            const botMap = JSON.parse(localStorage.getItem('bot_map') || '{}');
            
            // 如果没有配置，显示友好提示
            if (!apiKey || apiKey === 'YOUR_COZE_API_KEY') {
                return null;
            }
            
            return { apiKey, botMap };
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始初始化');
            generateCelebrityCards();
            bindEvents();
            
            // 生成用户会话ID以确保隔离
            const sessionId = generateUserSessionId();
            console.log('当前用户会话:', sessionId);
        });

        // 生成角色卡片
        function generateCelebrityCards() {
            const grid = document.getElementById('celebrities-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            CELEBRITIES_DATA.forEach((celebrity, index) => {
                const card = createCelebrityCard(celebrity);
                grid.appendChild(card);
            });
        }

        // 创建单个角色卡片
        function createCelebrityCard(celebrity) {
            const card = document.createElement('div');
            card.className = 'celebrity-card';
            
            card.onclick = function() {
                startChatWithCelebrity(celebrity);
            };

            card.innerHTML = `
                <div class="avatar-container">
                    <img class="celebrity-avatar" 
                         src="${celebrity.avatar}" 
                         alt="${celebrity.name}"
                         onerror="this.src='images/default-avatar.jpg'">
                </div>
                <div class="celebrity-name">${celebrity.name}</div>
                <div class="celebrity-period">${celebrity.period}</div>
                <div class="celebrity-desc">${celebrity.description}</div>
            `;

            return card;
        }

        // 开始与指定角色对话
        function startChatWithCelebrity(celebrity) {
            console.log('开始与角色对话:', celebrity.name);
            
            const config = getApiConfig();
            if (!config) {
                showConfigNeeded();
                return;
            }
            
            currentCharacter = celebrity;
            updateChatPageInfo(celebrity);
            showChatPage();
            initializeChatWithCoze(celebrity, config);
        }

        // 显示需要配置的友好提示
        function showConfigNeeded() {
            alert('对话功能正在准备中，请稍后再试！');
        }

        // 初始化与Coze的聊天连接 - 使用原版API方式
        function initializeChatWithCoze(celebrity, config) {
            const container = document.getElementById('coze-chat-container');
            const botId = config.botMap[celebrity.id] || celebrity.botId;
            
            if (!botId || botId.startsWith('YOUR_')) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🚧</div>
                        <h3>${celebrity.name} 暂时不可用</h3>
                        <p style="margin: 16px 0; text-align: center; line-height: 1.5;">该角色还在开发中，敬请期待！</p>
                    </div>
                `;
                return;
            }

            // 创建聊天界面
            createChatInterface(container, celebrity, config);
        }

        // 创建聊天界面
        function createChatInterface(container, celebrity, config) {
            const sessionId = generateUserSessionId();
            
            container.innerHTML = `
                <div class="chat-container" style="height: 100%; display: flex; flex-direction: column;">
                    <!-- 消息区域 -->
                    <div class="messages-area" style="flex: 1; padding: 16px; overflow-y: auto; background: #f8f9fa;">
                        <div class="welcome-message" style="
                            background: white; 
                            border-radius: 16px; 
                            padding: 24px; 
                            margin-bottom: 16px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            text-align: center;
                        ">
                            <img src="${celebrity.avatar}" alt="${celebrity.name}" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                 style="
                                    width: 80px; 
                                    height: 80px; 
                                    border-radius: 50%; 
                                    object-fit: cover; 
                                    border: 3px solid #667eea; 
                                    margin-bottom: 16px;
                                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                                 ">
                            <div style="font-size: 2.5rem; margin-bottom: 16px; display: none;">👋</div>
                            <h3 style="margin: 0 0 8px 0; color: #333;">你好！我是 ${celebrity.name}</h3>
                            <p style="margin: 0 0 20px 0; color: #666; line-height: 1.5;">
                                ${celebrity.description}<br>
                                有什么想了解的，尽管问我吧！
                            </p>
                            
                            <!-- 推荐问题容器（进入页面后将从接口填充） -->
                            <div id="suggestions-area" style="
                                display: flex;
                                flex-direction: column;
                                gap: 8px;
                                margin-top: 16px;
                                max-width: 300px;
                                margin-left: auto;
                                margin-right: auto;
                            ">
                                <div style="font-size: 14px; color: #888; margin-bottom: 4px; font-weight: 500;">💡 试试这些问题：</div>
                                ${celebrity.presetQuestions ? celebrity.presetQuestions.slice(0,3).map(question => `
                                    <button 
                                        onclick=\"sendPresetQuestion('${question.replace(/'/g, "\\'")}')\"
                                        style="
                                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                            color: white;
                                            border: none;
                                            border-radius: 20px;
                                            padding: 10px 16px;
                                            font-size: 14px;
                                            cursor: pointer;
                                            transition: all 0.2s ease;
                                            text-align: left;
                                            line-height: 1.3;
                                        "
                                        onmouseover=\"this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';\"
                                        onmouseout=\"this.style.transform=''; this.style.boxShadow='';\"
                                    >${question}</button>
                                `).join('') : ''}
                            </div>
                        </div>
                        <div id="chat-messages" style="min-height: 200px;">
                            <!-- 消息将在这里显示 -->
                        </div>
                    </div>
                    
                    <!-- 输入区域 -->
                    <div class="input-area" style="
                        background: white; 
                        border-top: 1px solid #e5e5e5; 
                        padding: 16px;
                        box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
                    ">
                        <div style="display: flex; gap: 12px; align-items: end;">
                            <textarea 
                                id="message-input" 
                                placeholder="输入你想说的话..."
                                style="
                                    flex: 1; 
                                    border: 2px solid #e5e5e5; 
                                    border-radius: 12px; 
                                    padding: 12px 16px; 
                                    resize: none; 
                                    font-size: 16px; 
                                    line-height: 1.4;
                                    max-height: 100px;
                                    min-height: 44px;
                                "
                                rows="1"
                                onkeydown="handleInputKeydown(event)"
                                oninput="adjustTextareaHeight(this)"
                            ></textarea>
                            <button 
                                id="send-button" 
                                onclick="sendMessage()"
                                style="
                                    background: #667eea; 
                                    color: white; 
                                    border: none; 
                                    border-radius: 12px; 
                                    padding: 12px 20px; 
                                    font-size: 16px; 
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: background 200ms ease;
                                    min-width: 60px;
                                "
                                onmouseover="this.style.background='#5a67d8'"
                                onmouseout="this.style.background='#667eea'"
                            >
                                发送
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // 初始化聊天功能
            initChatFunctionality(celebrity, config, sessionId);
        }

        // 初始化聊天功能
        function initChatFunctionality(celebrity, config, sessionId) {
            window.currentChatConfig = {
                celebrity: celebrity,
                apiKey: config.apiKey,
                botId: config.botMap[celebrity.id] || celebrity.botId,
                sessionId: sessionId,
                conversationId: null,
                chatHistory: []
            };

            console.log('聊天功能初始化完成:', window.currentChatConfig);
        }

        // 处理输入框按键
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 自动调整输入框高度
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // 刷新推荐问题（欢迎区或对话后）
        async function refreshSuggestions(position = 'welcome') {
            try {
                const cfg = window.currentChatConfig;
                if (!cfg || !cfg.apiKey || !cfg.botId) return;

                // 从接口获取建议问题（浏览器直连路径由你提供为 X）
                const url = `X?bot_id=${encodeURIComponent(cfg.botId)}${cfg.conversationId ? `&conversation_id=${encodeURIComponent(cfg.conversationId)}` : ''}`;
                const res = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${cfg.apiKey}`
                    }
                });
                if (!res.ok) throw new Error('suggestions http ' + res.status);
                const data = await res.json();

                const questions = (data?.data?.suggestions || data?.suggestions || [])
                    .filter(Boolean)
                    .map(q => (typeof q === 'string' ? q : q.title || q.text || ''))
                    .filter(Boolean)
                    .slice(0, 3);

                if (questions.length === 0) return;

                if (position === 'welcome') {
                    // 渲染到欢迎区容器
                    const box = document.getElementById('suggestions-area');
                    if (!box) return;
                    box.innerHTML = [
                        '<div style="font-size:14px;color:#888;margin-bottom:4px;font-weight:500;">💡 试试这些问题：</div>',
                        ...questions.map(q => `
                            <button onclick=\"sendPresetQuestion('${q.replace(/'/g, "\\'")}')\" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:20px;padding:10px 16px;font-size:14px;cursor:pointer;transition:all .2s ease;text-align:left;line-height:1.3;" onmouseover=\"this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(102,126,234,.3)';\" onmouseout=\"this.style.transform='';this.style.boxShadow='';\">${q}</button>`)
                    ].join('');
                } else {
                    // 渲染到最后一条 AI 回复下方
                    const messages = document.getElementById('chat-messages');
                    if (!messages) return;
                    const lastAssistant = Array.from(messages.children).reverse().find(el => el.querySelector && el.querySelector('.message-content'));
                    if (!lastAssistant) return;
                    const ext = document.createElement('div');
                    ext.style.cssText = 'margin:8px 0 16px 0;display:flex;flex-direction:column;gap:8px;';
                    ext.innerHTML = [
                        '<div style="font-size:12px;color:#999;">你还可以继续问：</div>',
                        ...questions.map(q => `
                            <button onclick=\"sendPresetQuestion('${q.replace(/'/g, "\\'")}')\" style="background:#f1f5ff;color:#3f51b5;border:none;border-radius:16px;padding:8px 12px;font-size:13px;text-align:left;">${q}</button>`)
                    ].join('');
                    messages.appendChild(ext);
                    messages.scrollTop = messages.scrollHeight;
                }
            } catch (e) {
                console.warn('获取建议问题失败：', e);
            }
        }

        // 发送消息
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            const config = window.currentChatConfig;
            if (!config) {
                alert('聊天配置错误，请刷新页面重试');
                return;
            }

            // 清空输入框
            input.value = '';
            adjustTextareaHeight(input);

            // 显示用户消息
            addMessageToChat('user', message);

            // 显示正在输入状态
            const typingId = addMessageToChat('assistant', '', true);

            try {
                // 调用 Coze API
                const response = await callCozeAPI(message, config);
                
                // 移除输入状态，显示回复
                removeMessage(typingId);
                const messageId = addMessageToChat('assistant', response.text);
                
                // 🎵 尝试生成Coze TTS音频
                tryGenerateCozeAudio(messageId, response.text);
                
                // 刷新对话后的推荐问题（来自Chat响应）
                if (Array.isArray(response.suggestions) && response.suggestions.length) {
                    const messages = document.getElementById('chat-messages');
                    const ext = document.createElement('div');
                    ext.style.cssText = 'margin:8px 0 16px 0;display:flex;flex-direction:column;gap:8px;';
                    ext.innerHTML = [
                        '<div style="font-size:12px;color:#999;">你还可以继续问：</div>',
                        ...response.suggestions.map(q => `
                            <button onclick=\"sendPresetQuestion('${q.replace(/'/g, "\\'")}')\" style="background:#f1f5ff;color:#3f51b5;border:none;border-radius:16px;padding:8px 12px;font-size:13px;text-align:left;">${q}</button>`)
                    ].join('');
                    messages.appendChild(ext);
                    messages.scrollTop = messages.scrollHeight;
                }
                
                console.log('✅ 消息发送完成，正在尝试生成Coze音色...');

            } catch (error) {
                console.error('发送消息失败:', error);
                removeMessage(typingId);
                addMessageToChat('assistant', '抱歉，我现在有点忙，请稍后再试。');
            }
        }

        // 发送预设问题
        function sendPresetQuestion(question) {
            // 将预设问题填入输入框并发送
            const input = document.getElementById('message-input');
            input.value = question;
            
            // 调整输入框高度
            adjustTextareaHeight(input);
            
            // 触发发送
            sendMessage();
        }

        // 添加消息到聊天
        function addMessageToChat(role, content, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const isUser = role === 'user';
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.cssText = `
                display: flex;
                margin-bottom: 16px;
                ${isUser ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}
            `;

            if (isTyping) {
                messageDiv.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 18px;
                        padding: 12px 16px;
                        max-width: 80%;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <div style="
                            width: 8px; height: 8px;
                            background: #667eea;
                            border-radius: 50%;
                            animation: pulse 1.5s infinite;
                        "></div>
                        <div style="
                            width: 8px; height: 8px;
                            background: #667eea;
                            border-radius: 50%;
                            animation: pulse 1.5s infinite 0.2s;
                        "></div>
                        <div style="
                            width: 8px; height: 8px;
                            background: #667eea;
                            border-radius: 50%;
                            animation: pulse 1.5s infinite 0.4s;
                        "></div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div style="
                        background: ${isUser ? '#667eea' : 'white'};
                        color: ${isUser ? 'white' : '#333'};
                        border-radius: 18px;
                        padding: 12px 16px;
                        max-width: 80%;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        line-height: 1.5;
                        word-wrap: break-word;
                        position: relative;
                    ">
                        <div class="message-content">${content}</div>
                        ${!isUser ? `
                            <div style="
                                display: flex;
                                gap: 6px;
                                margin-top: 8px;
                                padding-top: 8px;
                                border-top: 1px solid #f0f0f0;
                                justify-content: flex-start;
                            ">
                                <button onclick="regenerateResponse('${messageId}')" style="
                                    background: none;
                                    border: 1px solid #e5e5e5;
                                    border-radius: 12px;
                                    padding: 3px 8px;
                                    font-size: 11px;
                                    color: #666;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 3px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                    🔄 重新生成
                                </button>
                                <button onclick="speakMessage('${messageId}')" style="
                                    background: none;
                                    border: 1px solid #e5e5e5;
                                    border-radius: 12px;
                                    padding: 3px 8px;
                                    font-size: 11px;
                                    color: #666;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 3px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                    🔊 朗读
                                </button>
                                <button onclick="deleteMessage('${messageId}')" style="
                                    background: none;
                                    border: 1px solid #ffebee;
                                    border-radius: 12px;
                                    padding: 3px 8px;
                                    font-size: 11px;
                                    color: #f44336;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 3px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='none'">
                                    🗑️ 删除
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        // 移除消息
        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        // 重新生成回复
        async function regenerateResponse(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const config = window.currentChatConfig;
            if (!config || !config.chatHistory.length) {
                alert('无法重新生成，对话历史为空');
                return;
            }
            
            // 获取最后一条用户消息
            const lastUserMessage = config.chatHistory
                .slice()
                .reverse()
                .find(msg => msg.role === 'user');
                
            if (!lastUserMessage) {
                alert('找不到用户消息，无法重新生成');
                return;
            }
            
            // 显示重新生成状态
            const contentDiv = messageElement.querySelector('.message-content');
            const originalContent = contentDiv.innerHTML;
            contentDiv.innerHTML = '🔄 正在重新生成...';
            
            try {
                // 调用API重新生成
                const response = await callCozeAPI(lastUserMessage.content, config);
                contentDiv.innerHTML = response.text;
                
                // 🎵 尝试为重新生成的消息生成Coze TTS音频
                tryGenerateCozeAudio(messageId, response.text);
                
                console.log('✅ 消息重新生成完成');
                
                // 📝 更新聊天历史中的最后一条助手回复
                const lastAssistantIndex = config.chatHistory.map((msg, index) => ({msg, index}))
                    .reverse()
                    .find(item => item.msg.role === 'assistant')?.index;
                    
                if (lastAssistantIndex !== undefined) {
                    config.chatHistory[lastAssistantIndex].content = response.text;
                    console.log('✅ 已更新聊天历史');
                }
                
            } catch (error) {
                console.error('重新生成失败:', error);
                contentDiv.innerHTML = originalContent;
                alert('重新生成失败，请稍后重试');
            }
        }

        // 语音播放功能
        function speakMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const contentDiv = messageElement.querySelector('.message-content');
            const text = contentDiv.textContent || contentDiv.innerText;
            
            // 检查浏览器是否支持语音合成
            if (!('speechSynthesis' in window)) {
                alert('您的浏览器不支持语音播放功能');
                return;
            }
            
            // 停止当前播放
            speechSynthesis.cancel();
            
            // 创建语音合成对象
            const utterance = new SpeechSynthesisUtterance(text);
            
            // 🎭 根据角色设置专属语音参数
            const voiceSettings = getCharacterVoiceSettings();
            utterance.lang = 'zh-CN'; // 中文
            utterance.rate = voiceSettings.rate; // 角色专属语速
            utterance.pitch = voiceSettings.pitch; // 角色专属音调
            utterance.volume = voiceSettings.volume; // 音量
            
            // 🎵 智能选择最佳中文语音
            const voices = speechSynthesis.getVoices();
            const chineseVoices = voices.filter(voice => 
                voice.lang.includes('zh') || voice.lang.includes('CN') || voice.lang.includes('Chinese')
            );
            
            if (chineseVoices.length > 0) {
                // 智能语音选择策略
                let selectedVoice = null;
                
                if (voiceSettings.preferMale) {
                    // 男声优先级：明确男声 > 非女声 > 默认
                    selectedVoice = chineseVoices.find(voice => 
                        voice.name.includes('Male') || voice.name.includes('男') || voice.name.includes('Male')
                    ) || chineseVoices.find(voice => 
                        !voice.name.includes('Female') && !voice.name.includes('女')
                    ) || chineseVoices[0];
                } else {
                    // 女声优先级
                    selectedVoice = chineseVoices.find(voice => 
                        voice.name.includes('Female') || voice.name.includes('女')
                    ) || chineseVoices[0];
                }
                
                utterance.voice = selectedVoice;
                console.log(`🎭 ${currentCharacter?.name || '角色'} 使用语音: ${selectedVoice.name} (${selectedVoice.lang})`);
                console.log(`🎵 语音设置: 语速${voiceSettings.rate} 音调${voiceSettings.pitch} - ${voiceSettings.description}`);
            } else {
                console.log('⚠️ 未找到中文语音，使用默认语音');
            }
            
            // 更新按钮状态和视觉效果
            const button = messageElement.querySelector('button[onclick*="speakMessage"]');
            const originalText = button.innerHTML;
            const originalStyle = button.style.cssText;
            
            button.innerHTML = '⏸️ 停止朗读';
            button.style.background = '#dc3545';
            button.style.color = 'white';
            button.onclick = function() {
                speechSynthesis.cancel();
                button.innerHTML = originalText;
                button.style.cssText = originalStyle;
                button.onclick = function() { speakMessage(messageId); };
            };
            
            // 播放开始时的视觉反馈
            utterance.onstart = function() {
                console.log(`🎭 开始朗读 ${currentCharacter?.name || '角色'} 的回答`);
                button.style.animation = 'pulse 1.5s infinite';
            };
            
            // 播放完成后恢复按钮
            utterance.onend = function() {
                button.innerHTML = originalText;
                button.style.cssText = originalStyle;
                button.onclick = function() { speakMessage(messageId); };
                console.log('🎵 朗读完成');
            };
            
            // 播放错误时恢复按钮
            utterance.onerror = function(event) {
                console.error('🎵 朗读失败:', event.error);
                button.innerHTML = originalText;
                button.style.cssText = originalStyle;
                button.onclick = function() { speakMessage(messageId); };
            };
            
            // 开始播放
            speechSynthesis.speak(utterance);
        }

        // 删除消息
        function deleteMessage(messageId) {
            if (confirm('确定要删除这条消息吗？')) {
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    // 添加删除动画
                    messageElement.style.transition = 'opacity 0.3s, transform 0.3s';
                    messageElement.style.opacity = '0';
                    messageElement.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        messageElement.remove();
                        
                        // 从对话历史中删除对应消息
                        const config = window.currentChatConfig;
                        if (config && config.chatHistory) {
                            // 这里可以根据需要实现更精确的历史记录清理
                            console.log('消息已删除:', messageId);
                        }
                    }, 300);
                }
            }
        }

        // 🎵 调用Coze TTS API生成智能体音频 - 多端点尝试
        async function generateCozeAudio(text, voiceId, apiKey) {
            console.log(`🎵 开始调用Coze TTS API，语音ID: ${voiceId}`);
            console.log(`🎵 文本内容: ${text}`);

            // 定义多个可能的端点和参数组合
            const endpoints = [
                {
                    url: 'https://api.coze.cn/open_api/v2/audio/speech',
                    params: {
                        voice_id: voiceId,
                        text: text,
                        format: 'mp3',
                        speed: 1.0
                    }
                },
                {
                    url: 'https://api.coze.cn/open_api/v2/text_to_speech',
                    params: {
                        voice_id: voiceId,
                        text: text,
                        format: 'mp3',
                        speed: 1.0,
                        volume: 1.0
                    }
                },
                {
                    url: 'https://api.coze.cn/v1/text_to_speech',
                    params: {
                        voice_id: voiceId,
                        input: text,
                        response_format: 'mp3'
                    }
                },
                {
                    url: 'https://api.coze.cn/api/v2/text_to_speech',
                    params: {
                        bot_id: '7534668235225219091', // 李白的Bot ID
                        voice_id: voiceId,
                        text: text,
                        audio_format: 'mp3'
                    }
                }
            ];

            // 逐一尝试每个端点
            for (let i = 0; i < endpoints.length; i++) {
                const endpoint = endpoints[i];
                console.log(`🔍 尝试端点 ${i + 1}/${endpoints.length}: ${endpoint.url}`);

                try {
                    const response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(endpoint.params)
                    });

                    console.log(`📡 端点 ${i + 1} 响应状态: ${response.status} ${response.statusText}`);

                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        
                        // 检查是否返回音频文件
                        if (contentType && contentType.includes('audio/')) {
                            console.log('✅ 获得音频文件响应');
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            
                            return {
                                success: true,
                                audioUrl: audioUrl,
                                audioData: { size: audioBlob.size, type: contentType },
                                endpoint: endpoint.url
                            };
                        }
                        
                        // 检查是否返回JSON格式的音频URL
                        try {
                            const data = await response.json();
                            console.log(`📄 端点 ${i + 1} JSON响应:`, data);

                            // 检查多种可能的音频URL字段
                            const audioUrl = data.audio_url || 
                                           data.data?.audio_url || 
                                           data.result?.audio_url ||
                                           data.url;

                            if (audioUrl) {
                                console.log('✅ 在JSON响应中找到音频URL');
                                return {
                                    success: true,
                                    audioUrl: audioUrl,
                                    audioData: data,
                                    endpoint: endpoint.url
                                };
                            }

                            if (data.code === 0) {
                                console.log('⚠️ API调用成功但未找到音频数据');
                            } else {
                                console.log(`❌ API返回错误: ${data.code} - ${data.msg || data.message}`);
                            }
                        } catch (e) {
                            console.log('⚠️ 响应不是有效的JSON格式');
                        }
                    } else {
                        // 记录错误但继续尝试下一个端点
                        try {
                            const errorData = await response.json();
                            console.log(`❌ 端点 ${i + 1} 错误:`, errorData);
                        } catch (e) {
                            const errorText = await response.text();
                            console.log(`❌ 端点 ${i + 1} 错误: ${errorText}`);
                        }
                    }

                } catch (error) {
                    console.log(`❌ 端点 ${i + 1} 请求失败: ${error.message}`);
                }
            }

            // 所有端点都失败
            console.error('❌ 所有TTS端点都失败，回退到浏览器TTS');
            return {
                success: false,
                error: '所有Coze TTS端点都不可用',
                fallbackTTS: true
            };
        }

        // 🔊 为消息添加智能体音频功能
        async function addCozeAudioToMessage(messageId, text) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) {
                console.warn('找不到消息元素:', messageId);
                return;
            }

            const messageActions = messageElement.querySelector('.message-actions');
            if (!messageActions) {
                console.warn('找不到消息操作区域');
                return;
            }

            // 获取当前角色的语音配置
            const voiceId = getCurrentCharacterVoiceId();
            if (!voiceId) {
                console.log('⚠️ 当前角色未配置Coze语音ID，跳过TTS生成');
                return;
            }

            // 检查是否已经有智能体音频按钮
            const existingAudioBtn = messageActions.querySelector('.coze-audio-btn');
            if (existingAudioBtn) {
                existingAudioBtn.remove();
            }

            // 创建智能体音频按钮
            const audioBtn = document.createElement('button');
            audioBtn.className = 'action-btn coze-audio-btn';
            audioBtn.innerHTML = '🎵 扣子音色';
            audioBtn.title = '播放智能体原生音色';
            audioBtn.disabled = true; // 初始禁用，生成完成后启用
            
            // 插入到第一个位置
            const readBtn = messageActions.querySelector('[onclick*="speakMessage"]');
            if (readBtn) {
                messageActions.insertBefore(audioBtn, readBtn);
            } else {
                messageActions.appendChild(audioBtn);
            }

            // 异步生成音频
            audioBtn.innerHTML = '⏳ 生成中...';
            
            const config = getCurrentConfig();
            const audioResult = await generateCozeAudio(text, voiceId, config.apiKey);
            
            if (audioResult.success && audioResult.audioUrl) {
                audioBtn.innerHTML = '🎵 扣子音色';
                audioBtn.disabled = false;
                audioBtn.onclick = function() {
                    playCozeAudio(audioResult.audioUrl, audioBtn);
                };
                console.log('✅ 智能体音频生成成功');
            } else {
                audioBtn.innerHTML = '❌ 生成失败';
                audioBtn.disabled = true;
                audioBtn.title = `生成失败: ${audioResult.error}`;
                console.error('❌ 智能体音频生成失败:', audioResult.error);
            }
        }

        // 🎵 获取当前角色的Coze语音ID
        function getCurrentCharacterVoiceId() {
            if (!currentCharacter) return null;

            // 从localStorage获取角色的语音配置
            const voiceMap = JSON.parse(localStorage.getItem('character_voice_map') || '{}');
            return voiceMap[currentCharacter.id] || getDefaultVoiceId(currentCharacter.id);
        }

        // 🎭 获取角色默认语音ID（基于之前检测到的配置）
        function getDefaultVoiceId(characterId) {
            const defaultVoices = {
                'libai': '7481299960424579126', // 从你的配置检测结果中获得
                // 其他角色可以配置相同或不同的语音ID
            };
            return defaultVoices[characterId] || '7481299960424579126';
        }

        // 🎵 播放Coze智能体音频
        function playCozeAudio(audioUrl, buttonElement) {
            // 停止其他音频
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }

            // 停止浏览器TTS
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }

            try {
                console.log('🎵 播放Coze智能体音频:', audioUrl);
                const audio = new Audio(audioUrl);
                window.currentAudio = audio;

                // 更新按钮状态
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '⏸️ 停止播放';
                buttonElement.disabled = false;

                audio.onplay = () => {
                    console.log('✅ 开始播放Coze智能体音频');
                };

                audio.onended = () => {
                    console.log('✅ Coze智能体音频播放完成');
                    buttonElement.innerHTML = originalText;
                    buttonElement.onclick = () => playCozeAudio(audioUrl, buttonElement);
                    window.currentAudio = null;
                };

                audio.onerror = (error) => {
                    console.error('❌ Coze智能体音频播放失败:', error);
                    buttonElement.innerHTML = originalText;
                    buttonElement.onclick = () => playCozeAudio(audioUrl, buttonElement);
                    window.currentAudio = null;
                    showNotification('智能体音频播放失败');
                };

                // 点击停止播放
                buttonElement.onclick = function() {
                    audio.pause();
                    buttonElement.innerHTML = originalText;
                    buttonElement.onclick = () => playCozeAudio(audioUrl, buttonElement);
                    window.currentAudio = null;
                };

                audio.play();

            } catch (error) {
                console.error('❌ 创建Coze音频失败:', error);
                showNotification('音频播放失败');
            }
        }

        // 🔍 获取智能体配置信息（调试用）
        async function getBotConfigInfo() {
            if (!currentCharacter) {
                console.log('❌ 当前没有选择角色');
                return;
            }

            const apiKey = localStorage.getItem('coze_api_key');
            const botMap = JSON.parse(localStorage.getItem('bot_map') || '{}');
            const botId = botMap[currentCharacter.id] || currentCharacter.botId;

            if (!apiKey || !botId) {
                console.log('❌ 缺少API配置');
                return;
            }

            try {
                console.log(`🔍 获取 ${currentCharacter.name} 的配置信息...`);
                
                const response = await fetch(`https://api.coze.cn/open_api/v2/bots/${botId}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('🤖 智能体完整配置:', result);

                if (result.code === 0 && result.data) {
                    const config = result.data;
                    console.log('📊 配置分析:', {
                        name: config.name,
                        hasVoice: !!(config.voice_setting && Object.keys(config.voice_setting).length > 0),
                        voiceConfig: config.voice_setting,
                        pluginCount: config.plugin_info_list ? config.plugin_info_list.length : 0,
                        plugins: config.plugin_info_list,
                        model: config.model_info?.model_name
                    });
                }

            } catch (error) {
                console.error('❌ 获取配置失败:', error);
            }
        }

        // 🎭 获取角色专属语音设置
        function getCharacterVoiceSettings() {
            if (!currentCharacter) {
                return { rate: 0.8, pitch: 1.0, volume: 1.0, preferMale: true };
            }
            
            const voiceProfiles = {
                'libai': {
                    rate: 0.85,      // 略慢，体现诗人的吟诵感
                    pitch: 1.2,      // 略高，体现豪放气质
                    volume: 1.0,
                    preferMale: true,
                    description: '豪放诗人音色'
                },
                'luxun': {
                    rate: 0.7,       // 较慢，体现深沉思考
                    pitch: 0.9,      // 略低，体现严肃
                    volume: 1.0,
                    preferMale: true,
                    description: '文学家音色'
                },
                'edison': {
                    rate: 0.8,       // 中等语速
                    pitch: 1.1,      // 略高，体现发明家的活力
                    volume: 1.0,
                    preferMale: true,
                    description: '发明家音色'
                },
                'faraday': {
                    rate: 0.75,      // 略慢，体现科学家的严谨
                    pitch: 1.0,      // 标准音调
                    volume: 1.0,
                    preferMale: true,
                    description: '科学家音色'
                },
                'luobinwang': {
                    rate: 0.9,       // 稍快，体现儿童诗人的活泼
                    pitch: 1.3,      // 较高，体现年轻
                    volume: 1.0,
                    preferMale: true,
                    description: '少年诗人音色'
                },
                'wangwei': {
                    rate: 0.75,      // 慢速，体现山水诗人的宁静
                    pitch: 1.1,      // 略高，体现清雅
                    volume: 1.0,
                    preferMale: true,
                    description: '山水诗人音色'
                }
            };
            
            const profile = voiceProfiles[currentCharacter.id] || {
                rate: 0.8, pitch: 1.0, volume: 1.0, preferMale: true, description: '默认音色'
            };
            
            console.log(`🎭 ${currentCharacter.name} 使用: ${profile.description}`);
            return profile;
        }

        // 🎵 尝试生成Coze音频（简化调用）
        async function tryGenerateCozeAudio(messageId, text) {
            if (!currentCharacter) {
                console.log('⚠️ 当前没有角色，跳过Coze TTS');
                return;
            }

            const config = getCurrentConfig();
            if (!config || !config.apiKey) {
                console.log('⚠️ 没有API配置，跳过Coze TTS');
                return;
            }

            // 获取语音ID
            const voiceId = getCurrentCharacterVoiceId();
            if (!voiceId) {
                console.log(`⚠️ ${currentCharacter.name}未配置语音ID，跳过Coze TTS`);
                return;
            }

            console.log(`🎵 开始为${currentCharacter.name}生成Coze音色...`);

            try {
                const result = await generateCozeAudio(text, voiceId, config.apiKey);
                
                if (result.success) {
                    console.log(`✅ Coze TTS成功！使用端点: ${result.endpoint}`);
                    addCozeAudioButton(messageId, result.audioUrl);
                } else if (result.fallbackTTS) {
                    console.log('ℹ️ Coze TTS不可用，将使用增强的浏览器TTS');
                } else {
                    console.log(`❌ Coze TTS失败: ${result.error}`);
                }
            } catch (error) {
                console.error('❌ Coze TTS调用异常:', error);
            }
        }

        // 🎵 为消息添加Coze音频按钮
        function addCozeAudioButton(messageId, audioUrl) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;

            const messageActions = messageElement.querySelector('.message-actions');
            if (!messageActions) return;

            // 检查是否已有Coze音频按钮
            const existingBtn = messageActions.querySelector('.coze-audio-btn');
            if (existingBtn) {
                existingBtn.remove();
            }

            // 创建Coze音频按钮
            const audioBtn = document.createElement('button');
            audioBtn.className = 'action-btn coze-audio-btn';
            audioBtn.innerHTML = '🎭 扣子原声';
            audioBtn.title = '播放智能体原生音色';
            audioBtn.style.background = '#28a745';
            audioBtn.style.color = 'white';
            
            audioBtn.onclick = function() {
                playCozeAudio(audioUrl, audioBtn);
            };

            // 插入到朗读按钮之前
            const readBtn = messageActions.querySelector('[onclick*="speakMessage"]');
            if (readBtn) {
                messageActions.insertBefore(audioBtn, readBtn);
            } else {
                messageActions.appendChild(audioBtn);
            }

            console.log('✅ 已添加Coze音频按钮');
        }

        // 简单的通知函数
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // 这里可以添加更复杂的通知UI，目前使用console输出
        }

        // 将函数绑定到全局对象，确保HTML onclick能访问到
        window.regenerateResponse = regenerateResponse;
        window.speakMessage = speakMessage;
        window.deleteMessage = deleteMessage;
        window.sendPresetQuestion = sendPresetQuestion;
        window.getBotConfigInfo = getBotConfigInfo;

        // 调用 Coze API
        async function callCozeAPI(message, config) {
            const apiUrl = 'https://api.coze.cn/open_api/v2/chat';
            
            const requestBody = {
                bot_id: config.botId,
                user: config.sessionId,
                query: message,
                chat_history: config.chatHistory.slice(-6), // 保留最近6条对话
                stream: false, // 用户版本使用非流式以保证稳定性
                auto_save_history: true, // 自动保存历史
                meta_data: {}, // 元数据配置
                // 🎵 尝试请求音频输出
                enable_voice: true,
                voice_output: true,
                audio_format: "mp3"
            };

            if (config.conversationId) {
                requestBody.conversation_id = config.conversationId;
            }

            console.log('发送API请求:', requestBody);

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${config.apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status}`);
            }

            const data = await response.json();
            console.log('🔍 完整API响应数据:', data);
            
            if (data.code !== 0) {
                throw new Error(`API错误: ${data.msg}`);
            }

            // 🔊 检查音频信息
            let audioData = null;
            if (data.messages) {
                data.messages.forEach(msg => {
                    if (msg.content_type === 'audio' || msg.audio_url) {
                        console.log('🔊 发现音频信息:', msg);
                        audioData = {
                            url: msg.audio_url,
                            type: msg.content_type,
                            duration: msg.duration || null
                        };
                    }
                });
            }

            if (audioData) {
                console.log('✅ 智能体返回了音频数据:', audioData);
            } else {
                console.log('⚠️ 智能体未返回音频数据，将使用浏览器TTS');
            }

            // 提取回复内容 - 处理不同的响应格式
            let replyContent = '';
            
            if (data.messages && data.messages.length > 0) {
                // 查找最后一条 assistant 消息
                const assistantMessages = data.messages.filter(msg => 
                    msg.role === 'assistant' && msg.type === 'answer'
                );
                
                if (assistantMessages.length > 0) {
                    const lastMessage = assistantMessages[assistantMessages.length - 1];
                    replyContent = lastMessage.content;
                } else {
                    // 如果没有 answer 类型，取最后一条 assistant 消息
                    const allAssistantMessages = data.messages.filter(msg => msg.role === 'assistant');
                    if (allAssistantMessages.length > 0) {
                        replyContent = allAssistantMessages[allAssistantMessages.length - 1].content;
                    }
                }
            }

            // 清理可能的JSON格式错误
            if (replyContent && typeof replyContent === 'string') {
                // 移除可能的JSON前缀
                replyContent = replyContent.replace(/^\{"msg_type"[^}]+\}/, '').trim();
                // 移除其他可能的格式问题
                replyContent = replyContent.replace(/^[^a-zA-Z\u4e00-\u9fa5]*/, '').trim();
            }

            // 如果仍然没有有效内容，使用默认回复
            if (!replyContent) {
                replyContent = '抱歉，我没有理解你的问题，请再试一次。';
            }

            // 提取follow_up建议问题
            let followUps = [];
            if (data.messages && Array.isArray(data.messages)) {
                followUps = data.messages
                    .filter(m => m.role === 'assistant' && m.type === 'follow_up' && m.content)
                    .map(m => m.content)
                    .filter(Boolean);
            }

            // 更新对话历史
            config.conversationId = data.conversation_id;
            config.chatHistory.push(
                { role: 'user', content: message },
                { role: 'assistant', content: replyContent }
            );

            console.log('处理后的回复:', replyContent);
            
            // 返回包含文本、音频与建议问题的对象
            return {
                text: replyContent,
                audio: audioData,
                conversationId: data.conversation_id,
                hasAudio: !!audioData,
                suggestions: Array.from(new Set(followUps)).slice(0, 3)
            };
        }

        // 更新聊天页面角色信息
        function updateChatPageInfo(celebrity) {
            document.getElementById('current-char-name').textContent = celebrity.name;
            document.getElementById('current-char-period').textContent = celebrity.period;
            
            const avatarImg = document.getElementById('current-char-avatar');
            avatarImg.src = celebrity.avatar;
            avatarImg.onerror = () => avatarImg.src = 'images/default-avatar.jpg';
            
            document.title = `与${celebrity.name}对话中...`;
        }

        // 显示聊天页面
        function showChatPage() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-page').style.display = 'block';
        }

        // 显示首页
        function showHomePage() {
            document.getElementById('chat-page').style.display = 'none';
            document.getElementById('home-page').style.display = 'flex';
            
            // 清理聊天客户端
            if (currentChatClient) {
                currentChatClient.destroy && currentChatClient.destroy();
                currentChatClient = null;
            }
            
            document.title = '名人智能体对话';
        }

        // 绑定事件
        function bindEvents() {
            document.getElementById('back-btn').onclick = showHomePage;
        }
    </script>
</body>
</html> 