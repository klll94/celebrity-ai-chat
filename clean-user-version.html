<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åäººæ™ºèƒ½ä½“å¯¹è¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 430px;
            width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            background: transparent;
            position: relative;
        }

        /* é¦–é¡µæ ·å¼ - æ›´æ¸…æ–°çš„è®¾è®¡ */
        .home-page {
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: transparent;
        }

        .app-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .app-title {
            font-size: 2.4rem;
            font-weight: 300;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .app-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .celebrities-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            width: 100%;
            margin: 0 auto;
            flex: 1;
        }

        .celebrity-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 18px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 200ms ease;
            backdrop-filter: blur(10px);
        }

        .celebrity-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0,0,0,0.15);
            background: rgba(255, 255, 255, 1);
        }

        .celebrity-avatar {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            display: block;
            margin: 0 auto 12px;
        }

        .celebrity-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 6px;
        }

        .celebrity-period {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .celebrity-desc {
            font-size: 0.88rem;
            color: #666;
            line-height: 1.5;
        }

        /* èŠå¤©é¡µé¢æ ·å¼ */
        .chat-page {
            display: none;
            height: 100vh;
            position: relative;
            background: #f8f9fa;
        }

        .chat-page.show {
            display: block;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e5e5e5;
            position: relative;
            z-index: 10;
        }

        .back-btn {
            display: flex;
            align-items: center;
            color: #667eea;
            text-decoration: none;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .back-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .char-info {
            display: flex;
            align-items: center;
            flex: 1;
            justify-content: center;
            gap: 12px;
        }

        .char-avatar-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e5e5;
        }

        .char-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .char-period {
            font-size: 0.85rem;
            color: #888;
            margin: 0;
        }

        .coze-chat-container {
            position: absolute;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
        }

        .hidden { 
            display: none; 
        }

        .show { 
            display: block; 
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .app-title {
                font-size: 2rem;
            }
            
            .celebrity-avatar {
                width: 68px;
                height: 68px;
            }
            
            .celebrity-card {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¦–é¡µ - ç§»é™¤äº†å¼€å‘è€…æŒ‰é’®ï¼Œç•Œé¢æ›´æ¸…æ–° -->
        <div id="home-page" class="home-page">
            <div class="app-header">
                <div class="header-content">
                    <h1 class="app-title">åäººæ™ºèƒ½ä½“å¯¹è¯</h1>
                    <p class="app-subtitle">ä¸å†å²åäººè¿›è¡Œæ™ºèƒ½å¯¹è¯ï¼Œæ¢ç´¢çŸ¥è¯†çš„æµ·æ´‹</p>
                </div>
            </div>

            <div class="celebrities-section">
                <div id="celebrities-grid" class="celebrities-grid">
                    <!-- è§’è‰²å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- èŠå¤©é¡µé¢ -->
        <div id="chat-page" class="chat-page">
            <div class="chat-header">
                <button id="back-btn" class="back-btn">
                    <span>â†</span>
                    <span style="margin-left: 8px;">è¿”å›</span>
                </button>
                
                <div class="char-info">
                    <img id="current-char-avatar" class="char-avatar-img" src="" alt="è§’è‰²å¤´åƒ">
                    <div class="char-details">
                        <div id="current-char-name" class="char-name">åŠ è½½ä¸­...</div>
                        <div id="current-char-period" class="char-period"></div>
                    </div>
                </div>
                
                <div style="min-width: 80px;"></div>
            </div>
            
            <div id="coze-chat-container" class="coze-chat-container">
                <!-- Coze Chat å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
            </div>
        </div>
    </div>

    <script>
        console.log('å¼€å§‹åŠ è½½åäººæ™ºèƒ½ä½“å¯¹è¯åº”ç”¨...');

        // 18ä¸ªåäººæ•°æ®é…ç½®
        const CELEBRITIES_DATA = [
            {
                id: 'libai',
                name: 'æç™½',
                period: 'å”æœ (701-762)',
                description: 'å”ä»£æµªæ¼«ä¸»ä¹‰è¯—äººï¼Œè¢«èª‰ä¸º"è¯—ä»™"',
                avatar: 'images/æç™½.png',
                botId: 'YOUR_LIBAI_BOT_ID',
                presetQuestions: [
                    'æç™½å”å”ï¼Œä½ èƒ½æ•™æˆ‘å†™ä¸€é¦–ç®€å•çš„è¯—å—ï¼Ÿ',
                    'ä½ ä¸ºä»€ä¹ˆè¿™ä¹ˆå–œæ¬¢æœˆäº®å’Œé…’å‘¢ï¼Ÿ'
                ]
            },
            {
                id: 'luxun',
                name: 'é²è¿…',
                period: 'è¿‘ç°ä»£ (1881-1936)',
                description: 'ä¸­å›½ç°ä»£æ–‡å­¦å¥ åŸºäººã€æ€æƒ³å®¶ã€æ–‡å­¦å®¶ã€é©å‘½å®¶',
                avatar: 'images/é²è¿….png',
                botId: 'YOUR_LUXUN_BOT_ID',
                presetQuestions: [
                    'é²è¿…çˆ·çˆ·ï¼Œä½ å°æ—¶å€™æœ€å–œæ¬¢è¯»ä»€ä¹ˆä¹¦ï¼Ÿ',
                    'ä½ å†™çš„ã€Šä»ç™¾è‰å›­åˆ°ä¸‰å‘³ä¹¦å±‹ã€‹é‡Œå“ªä¸ªæ•…äº‹æœ€æœ‰è¶£ï¼Ÿ'
                ]
            },
            {
                id: 'edison',
                name: 'çˆ±è¿ªç”Ÿ',
                period: 'è¿‘ç°ä»£ (1847-1931)',
                description: 'ç¾å›½å‘æ˜å®¶ã€ä¼ä¸šå®¶ï¼Œæ‹¥æœ‰ä¼—å¤šé‡è¦å‘æ˜ä¸“åˆ©',
                avatar: 'images/çˆ±è¿ªç”Ÿ.png',
                botId: 'YOUR_EDISON_BOT_ID',
                presetQuestions: [
                    'å‘æ˜ç”µç¯æ³¡æ—¶é‡åˆ°äº†ä»€ä¹ˆå›°éš¾ï¼Ÿ',
                    'ä½ è®¤ä¸ºåˆ›æ–°çš„ç§˜è¯€æ˜¯ä»€ä¹ˆï¼Ÿ'
                ]
            },
            {
                id: 'faraday',
                name: 'æ³•æ‹‰ç¬¬',
                period: 'è¿‘ç°ä»£ (1791-1867)',
                description: 'è‹±å›½ç‰©ç†å­¦å®¶ã€åŒ–å­¦å®¶ï¼Œç”µç£å­¦å¥ åŸºäºº',
                avatar: 'images/æ³•æ‹‰ç¬¬.png',
                botId: 'YOUR_FARADAY_BOT_ID',
                presetQuestions: [
                    'èƒ½è§£é‡Šä¸€ä¸‹ç”µç£æ„Ÿåº”ç°è±¡å—ï¼Ÿ',
                    'ä½ æ˜¯å¦‚ä½•å‘ç°ç”µç£å®šå¾‹çš„ï¼Ÿ'
                ]
            },
            {
                id: 'luobinwang',
                name: 'éª†å®¾ç‹',
                period: 'å”æœ (çº¦640-684)',
                description: 'å”ä»£è¯—äººï¼Œ"åˆå”å››æ°"ä¹‹ä¸€',
                avatar: 'images/éª†å®¾ç‹.png',
                botId: 'YOUR_LUOBINWANG_BOT_ID',
                presetQuestions: [
                    'èƒ½åˆ†äº«ä¸€ä¸‹ä½ çš„ä»£è¡¨ä½œå“å—ï¼Ÿ',
                    'å¦‚ä½•çœ‹å¾…è¯—æ­Œçš„ç¤¾ä¼šä½œç”¨ï¼Ÿ'
                ]
            },
            {
                id: 'wangwei',
                name: 'ç‹ç»´',
                period: 'å”æœ (701-761)',
                description: 'å”ä»£è¯—äººã€ç”»å®¶ï¼Œå±±æ°´ç”°å›­è¯—æ´¾ä»£è¡¨',
                avatar: 'images/ç‹ç»´.png',
                botId: 'YOUR_WANGWEI_BOT_ID',
                presetQuestions: [
                    'èƒ½æè¿°ä¸€ä¸‹ä½ çœ¼ä¸­çš„å±±æ°´ä¹‹ç¾å—ï¼Ÿ',
                    'è¯—ç”»ç»“åˆçš„è‰ºæœ¯å¢ƒç•Œæ˜¯æ€æ ·çš„ï¼Ÿ'
                ]
            },
            {
                id: 'yeshengtao',
                name: 'å¶åœ£é™¶',
                period: 'ç°ä»£ (1894-1988)',
                description: 'ä¸­å›½ç°ä»£ä½œå®¶ã€æ•™è‚²å®¶ã€å‡ºç‰ˆå®¶',
                avatar: 'images/å¶åœ£é™¶.png',
                botId: 'YOUR_YESHENGTAO_BOT_ID'
            },
            {
                id: 'menghaoran',
                name: 'å­Ÿæµ©ç„¶',
                period: 'å”æœ (689-740)',
                description: 'å”ä»£è¯—äººï¼Œå±±æ°´ç”°å›­è¯—æ´¾ä»£è¡¨',
                avatar: 'images/å­Ÿæµ©ç„¶.png',
                botId: 'YOUR_MENGHAORAN_BOT_ID'
            },
            {
                id: 'baijuyi',
                name: 'ç™½å±…æ˜“',
                period: 'å”æœ (772-846)',
                description: 'å”ä»£è¯—äººï¼Œç°å®ä¸»ä¹‰è¯—æ­Œçš„å€¡å¯¼è€…',
                avatar: 'images/ç™½å±…æ˜“.png',
                botId: 'YOUR_BAIJUYI_BOT_ID'
            },
            {
                id: 'yangwanli',
                name: 'æ¨ä¸‡é‡Œ',
                period: 'å—å®‹ (1127-1206)',
                description: 'å—å®‹è¯—äººï¼Œ"ä¸­å…´å››å¤§è¯—äºº"ä¹‹ä¸€',
                avatar: 'images/æ¨ä¸‡é‡Œ.png',
                botId: 'YOUR_YANGWANLI_BOT_ID'
            },
            {
                id: 'jiadao',
                name: 'è´¾å²›',
                period: 'å”æœ (779-843)',
                description: 'å”ä»£è¯—äººï¼Œè‹¦åŸè¯—äººçš„ä»£è¡¨',
                avatar: 'images/è´¾å²›.png',
                botId: 'YOUR_JIADAO_BOT_ID'
            },
            {
                id: 'quyuan',
                name: 'å±ˆåŸ',
                period: 'æˆ˜å›½ (çº¦340-278BC)',
                description: 'ä¸­å›½å¤ä»£ä¼Ÿå¤§çš„çˆ±å›½è¯—äººï¼Œæ¥šè¾åˆ›ç«‹è€…',
                avatar: 'images/å±ˆåŸ.png',
                botId: 'YOUR_QUYUAN_BOT_ID'
            },
            {
                id: 'zhukezhen',
                name: 'ç«ºå¯æ¡¢',
                period: 'ç°ä»£ (1890-1974)',
                description: 'ä¸­å›½ç°ä»£æ°”è±¡å­¦å®¶ã€åœ°ç†å­¦å®¶',
                avatar: 'images/ç«ºå¯æ¡¢.png',
                botId: 'YOUR_ZHUKEZHEN_BOT_ID'
            },
            {
                id: 'shenkuo',
                name: 'æ²ˆæ‹¬',
                period: 'åŒ—å®‹ (1031-1095)',
                description: 'åŒ—å®‹ç§‘å­¦å®¶ã€æ”¿æ²»å®¶ï¼Œã€Šæ¢¦æºªç¬”è°ˆã€‹ä½œè€…',
                avatar: 'images/æ²ˆæ‹¬.png',
                botId: 'YOUR_SHENKUO_BOT_ID'
            },
            {
                id: 'tuyouyou',
                name: 'å± å‘¦å‘¦',
                period: 'ç°ä»£ (1930-)',
                description: 'ä¸­å›½è¯å­¦å®¶ï¼Œè¯ºè´å°”ç”Ÿç†å­¦æˆ–åŒ»å­¦å¥–è·å¾—è€…',
                avatar: 'images/å± å‘¦å‘¦.png',
                botId: 'YOUR_TUYOUYOU_BOT_ID'
            },
            {
                id: 'newton',
                name: 'ç‰›é¡¿',
                period: 'è¿‘ç°ä»£ (1643-1727)',
                description: 'è‹±å›½ç‰©ç†å­¦å®¶ã€æ•°å­¦å®¶ï¼Œç»å…¸åŠ›å­¦çš„å¥ åŸºäºº',
                avatar: 'images/ç‰›é¡¿.png',
                botId: 'YOUR_NEWTON_BOT_ID'
            },
            {
                id: 'galileo',
                name: 'ä¼½åˆ©ç•¥',
                period: 'è¿‘ç°ä»£ (1564-1642)',
                description: 'æ„å¤§åˆ©ç‰©ç†å­¦å®¶ã€å¤©æ–‡å­¦å®¶ï¼Œè¿‘ä»£ç§‘å­¦å¥ åŸºäºº',
                avatar: 'images/ä¼½åˆ©ç•¥.png',
                botId: 'YOUR_GALILEO_BOT_ID'
            },
            {
                id: 'nieer',
                name: 'è‚è€³',
                period: 'ç°ä»£ (1912-1935)',
                description: 'ä¸­å›½éŸ³ä¹å®¶ï¼Œã€Šä¹‰å‹‡å†›è¿›è¡Œæ›²ã€‹ä½œæ›²è€…',
                avatar: 'images/è‚è€³.png',
                botId: 'YOUR_NIEER_BOT_ID'
            }
        ];

        let currentChatClient = null;
        let currentCharacter = null;
        
        // ç”Ÿæˆå”¯ä¸€çš„ç”¨æˆ·ä¼šè¯ID - ç¡®ä¿ä¼šè¯éš”ç¦»
        function generateUserSessionId() {
            const saved = localStorage.getItem('user_session_id');
            if (saved) return saved;
            
            // ç”ŸæˆUUIDæ ¼å¼çš„ä¼šè¯ID
            const sessionId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('user_session_id', sessionId);
            console.log('ç”Ÿæˆæ–°çš„ç”¨æˆ·ä¼šè¯ID:', sessionId);
            return sessionId;
        }

        // è·å–é…ç½®ï¼ˆä»localStorageæˆ–ç¯å¢ƒå˜é‡ï¼‰
        function getApiConfig() {
            // ä¼˜å…ˆä»localStorageè·å–ï¼ˆå¼€å‘è€…åœ¨åå°é…ç½®çš„ï¼‰
            const apiKey = localStorage.getItem('coze_api_key');
            const botMap = JSON.parse(localStorage.getItem('bot_map') || '{}');
            
            // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
            if (!apiKey || apiKey === 'YOUR_COZE_API_KEY') {
                return null;
            }
            
            return { apiKey, botMap };
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            generateCelebrityCards();
            bindEvents();
            
            // ç”Ÿæˆç”¨æˆ·ä¼šè¯IDä»¥ç¡®ä¿éš”ç¦»
            const sessionId = generateUserSessionId();
            console.log('å½“å‰ç”¨æˆ·ä¼šè¯:', sessionId);
        });

        // ç”Ÿæˆè§’è‰²å¡ç‰‡
        function generateCelebrityCards() {
            const grid = document.getElementById('celebrities-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            CELEBRITIES_DATA.forEach((celebrity, index) => {
                const card = createCelebrityCard(celebrity);
                grid.appendChild(card);
            });
        }

        // åˆ›å»ºå•ä¸ªè§’è‰²å¡ç‰‡
        function createCelebrityCard(celebrity) {
            const card = document.createElement('div');
            card.className = 'celebrity-card';
            
            card.onclick = function() {
                startChatWithCelebrity(celebrity);
            };

            card.innerHTML = `
                <div class="avatar-container">
                    <img class="celebrity-avatar" 
                         src="${celebrity.avatar}" 
                         alt="${celebrity.name}"
                         onerror="this.src='images/default-avatar.jpg'">
                </div>
                <div class="celebrity-name">${celebrity.name}</div>
                <div class="celebrity-period">${celebrity.period}</div>
                <div class="celebrity-desc">${celebrity.description}</div>
            `;

            return card;
        }

        // å¼€å§‹ä¸æŒ‡å®šè§’è‰²å¯¹è¯
        function startChatWithCelebrity(celebrity) {
            console.log('å¼€å§‹ä¸è§’è‰²å¯¹è¯:', celebrity.name);
            
            const config = getApiConfig();
            if (!config) {
                showConfigNeeded();
                return;
            }
            
            currentCharacter = celebrity;
            updateChatPageInfo(celebrity);
            showChatPage();
            initializeChatWithCoze(celebrity, config);
        }

        // æ˜¾ç¤ºéœ€è¦é…ç½®çš„å‹å¥½æç¤º
        function showConfigNeeded() {
            alert('å¯¹è¯åŠŸèƒ½æ­£åœ¨å‡†å¤‡ä¸­ï¼Œè¯·ç¨åå†è¯•ï¼');
        }

        // åˆå§‹åŒ–ä¸Cozeçš„èŠå¤©è¿æ¥ - ä½¿ç”¨åŸç‰ˆAPIæ–¹å¼
        function initializeChatWithCoze(celebrity, config) {
            const container = document.getElementById('coze-chat-container');
            const botId = config.botMap[celebrity.id] || celebrity.botId;
            
            if (!botId || botId.startsWith('YOUR_')) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸš§</div>
                        <h3>${celebrity.name} æš‚æ—¶ä¸å¯ç”¨</h3>
                        <p style="margin: 16px 0; text-align: center; line-height: 1.5;">è¯¥è§’è‰²è¿˜åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>
                    </div>
                `;
                return;
            }

            // åˆ›å»ºèŠå¤©ç•Œé¢
            createChatInterface(container, celebrity, config);
        }

        // åˆ›å»ºèŠå¤©ç•Œé¢
        function createChatInterface(container, celebrity, config) {
            const sessionId = generateUserSessionId();
            
            container.innerHTML = `
                <div class="chat-container" style="height: 100%; display: flex; flex-direction: column;">
                    <!-- æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="messages-area" style="flex: 1; padding: 16px; overflow-y: auto; background: #f8f9fa;">
                        <div class="welcome-message" style="
                            background: white; 
                            border-radius: 16px; 
                            padding: 24px; 
                            margin-bottom: 16px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            text-align: center;
                        ">
                            <img src="${celebrity.avatar}" alt="${celebrity.name}" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                 style="
                                    width: 80px; 
                                    height: 80px; 
                                    border-radius: 50%; 
                                    object-fit: cover; 
                                    border: 3px solid #667eea; 
                                    margin-bottom: 16px;
                                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                                 ">
                            <div style="font-size: 2.5rem; margin-bottom: 16px; display: none;">ğŸ‘‹</div>
                            <h3 style="margin: 0 0 8px 0; color: #333;">ä½ å¥½ï¼æˆ‘æ˜¯ ${celebrity.name}</h3>
                            <p style="margin: 0 0 20px 0; color: #666; line-height: 1.5;">
                                ${celebrity.description}<br>
                                æœ‰ä»€ä¹ˆæƒ³äº†è§£çš„ï¼Œå°½ç®¡é—®æˆ‘å§ï¼
                            </p>
                            
                            <!-- æ¨èé—®é¢˜å®¹å™¨ï¼ˆè¿›å…¥é¡µé¢åå°†ä»æ¥å£å¡«å……ï¼‰ -->
                            <div id="suggestions-area" style="
                                display: flex;
                                flex-direction: column;
                                gap: 8px;
                                margin-top: 16px;
                                max-width: 300px;
                                margin-left: auto;
                                margin-right: auto;
                            ">
                                <div style="font-size: 14px; color: #888; margin-bottom: 4px; font-weight: 500;">ğŸ’¡ è¯•è¯•è¿™äº›é—®é¢˜ï¼š</div>
                                ${celebrity.presetQuestions ? celebrity.presetQuestions.slice(0,3).map(question => `
                                    <button 
                                        onclick=\"sendPresetQuestion('${question.replace(/'/g, "\\'")}')\"
                                        style="
                                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                            color: white;
                                            border: none;
                                            border-radius: 20px;
                                            padding: 10px 16px;
                                            font-size: 14px;
                                            cursor: pointer;
                                            transition: all 0.2s ease;
                                            text-align: left;
                                            line-height: 1.3;
                                        "
                                        onmouseover=\"this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';\"
                                        onmouseout=\"this.style.transform=''; this.style.boxShadow='';\"
                                    >${question}</button>
                                `).join('') : ''}
                            </div>
                        </div>
                        <div id="chat-messages" style="min-height: 200px;">
                            <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="input-area" style="
                        background: white; 
                        border-top: 1px solid #e5e5e5; 
                        padding: 16px;
                        box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
                    ">
                        <div style="display: flex; gap: 12px; align-items: end;">
                            <textarea 
                                id="message-input" 
                                placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..."
                                style="
                                    flex: 1; 
                                    border: 2px solid #e5e5e5; 
                                    border-radius: 12px; 
                                    padding: 12px 16px; 
                                    resize: none; 
                                    font-size: 16px; 
                                    line-height: 1.4;
                                    max-height: 100px;
                                    min-height: 44px;
                                "
                                rows="1"
                                onkeydown="handleInputKeydown(event)"
                                oninput="adjustTextareaHeight(this)"
                            ></textarea>
                            <button 
                                id="send-button" 
                                onclick="sendMessage()"
                                style="
                                    background: #667eea; 
                                    color: white; 
                                    border: none; 
                                    border-radius: 12px; 
                                    padding: 12px 20px; 
                                    font-size: 16px; 
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: background 200ms ease;
                                    min-width: 60px;
                                "
                                onmouseover="this.style.background='#5a67d8'"
                                onmouseout="this.style.background='#667eea'"
                            >
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
            initChatFunctionality(celebrity, config, sessionId);
        }

        // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
        function initChatFunctionality(celebrity, config, sessionId) {
            window.currentChatConfig = {
                celebrity: celebrity,
                apiKey: config.apiKey,
                botId: config.botMap[celebrity.id] || celebrity.botId,
                sessionId: sessionId,
                conversationId: null,
                chatHistory: []
            };

            console.log('èŠå¤©åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ:', window.currentChatConfig);
        }

        // å¤„ç†è¾“å…¥æ¡†æŒ‰é”®
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // åˆ·æ–°æ¨èé—®é¢˜ï¼ˆæ¬¢è¿åŒºæˆ–å¯¹è¯åï¼‰
        async function refreshSuggestions(position = 'welcome') {
            try {
                const cfg = window.currentChatConfig;
                if (!cfg || !cfg.apiKey || !cfg.botId) return;

                // ä»æ¥å£è·å–å»ºè®®é—®é¢˜ï¼ˆæµè§ˆå™¨ç›´è¿è·¯å¾„ç”±ä½ æä¾›ä¸º Xï¼‰
                const url = `X?bot_id=${encodeURIComponent(cfg.botId)}${cfg.conversationId ? `&conversation_id=${encodeURIComponent(cfg.conversationId)}` : ''}`;
                const res = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${cfg.apiKey}`
                    }
                });
                if (!res.ok) throw new Error('suggestions http ' + res.status);
                const data = await res.json();

                const questions = (data?.data?.suggestions || data?.suggestions || [])
                    .filter(Boolean)
                    .map(q => (typeof q === 'string' ? q : q.title || q.text || ''))
                    .filter(Boolean)
                    .slice(0, 3);

                if (questions.length === 0) return;

                if (position === 'welcome') {
                    // æ¸²æŸ“åˆ°æ¬¢è¿åŒºå®¹å™¨
                    const box = document.getElementById('suggestions-area');
                    if (!box) return;
                    box.innerHTML = [
                        '<div style="font-size:14px;color:#888;margin-bottom:4px;font-weight:500;">ğŸ’¡ è¯•è¯•è¿™äº›é—®é¢˜ï¼š</div>',
                        ...questions.map(q => `
                            <button onclick=\"sendPresetQuestion('${q.replace(/'/g, "\\'")}')\" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:20px;padding:10px 16px;font-size:14px;cursor:pointer;transition:all .2s ease;text-align:left;line-height:1.3;" onmouseover=\"this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(102,126,234,.3)';\" onmouseout=\"this.style.transform='';this.style.boxShadow='';\">${q}</button>`)
                    ].join('');
                } else {
                    // æ¸²æŸ“åˆ°æœ€åä¸€æ¡ AI å›å¤ä¸‹æ–¹
                    const messages = document.getElementById('chat-messages');
                    if (!messages) return;
                    const lastAssistant = Array.from(messages.children).reverse().find(el => el.querySelector && el.querySelector('.message-content'));
                    if (!lastAssistant) return;
                    const ext = document.createElement('div');
                    ext.style.cssText = 'margin:8px 0 16px 0;display:flex;flex-direction:column;gap:8px;';
                    ext.innerHTML = [
                        '<div style="font-size:12px;color:#999;">ä½ è¿˜å¯ä»¥ç»§ç»­é—®ï¼š</div>',
                        ...questions.map(q => `
                            <button onclick=\"sendPresetQuestion('${q.replace(/'/g, "\\'")}')\" style="background:#f1f5ff;color:#3f51b5;border:none;border-radius:16px;padding:8px 12px;font-size:13px;text-align:left;">${q}</button>`)
                    ].join('');
                    messages.appendChild(ext);
                    messages.scrollTop = messages.scrollHeight;
                }
            } catch (e) {
                console.warn('è·å–å»ºè®®é—®é¢˜å¤±è´¥ï¼š', e);
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            const config = window.currentChatConfig;
            if (!config) {
                alert('èŠå¤©é…ç½®é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            adjustTextareaHeight(input);

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessageToChat('user', message);

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çŠ¶æ€
            const typingId = addMessageToChat('assistant', '', true);

            try {
                // è°ƒç”¨ Coze API
                const response = await callCozeAPI(message, config);
                
                // ç§»é™¤è¾“å…¥çŠ¶æ€ï¼Œæ˜¾ç¤ºå›å¤
                removeMessage(typingId);
                const messageId = addMessageToChat('assistant', response.text);
                
                // ğŸµ å°è¯•ç”ŸæˆCoze TTSéŸ³é¢‘
                tryGenerateCozeAudio(messageId, response.text);
                
                // åˆ·æ–°å¯¹è¯åçš„æ¨èé—®é¢˜ï¼ˆæ¥è‡ªChatå“åº”ï¼‰
                if (Array.isArray(response.suggestions) && response.suggestions.length) {
                    const messages = document.getElementById('chat-messages');
                    const ext = document.createElement('div');
                    ext.style.cssText = 'margin:8px 0 16px 0;display:flex;flex-direction:column;gap:8px;';
                    ext.innerHTML = [
                        '<div style="font-size:12px;color:#999;">ä½ è¿˜å¯ä»¥ç»§ç»­é—®ï¼š</div>',
                        ...response.suggestions.map(q => `
                            <button onclick=\"sendPresetQuestion('${q.replace(/'/g, "\\'")}')\" style="background:#f1f5ff;color:#3f51b5;border:none;border-radius:16px;padding:8px 12px;font-size:13px;text-align:left;">${q}</button>`)
                    ].join('');
                    messages.appendChild(ext);
                    messages.scrollTop = messages.scrollHeight;
                }
                
                console.log('âœ… æ¶ˆæ¯å‘é€å®Œæˆï¼Œæ­£åœ¨å°è¯•ç”ŸæˆCozeéŸ³è‰²...');

            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                removeMessage(typingId);
                addMessageToChat('assistant', 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
        }

        // å‘é€é¢„è®¾é—®é¢˜
        function sendPresetQuestion(question) {
            // å°†é¢„è®¾é—®é¢˜å¡«å…¥è¾“å…¥æ¡†å¹¶å‘é€
            const input = document.getElementById('message-input');
            input.value = question;
            
            // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            adjustTextareaHeight(input);
            
            // è§¦å‘å‘é€
            sendMessage();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessageToChat(role, content, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const isUser = role === 'user';
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.style.cssText = `
                display: flex;
                margin-bottom: 16px;
                ${isUser ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}
            `;

            if (isTyping) {
                messageDiv.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 18px;
                        padding: 12px 16px;
                        max-width: 80%;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <div style="
                            width: 8px; height: 8px;
                            background: #667eea;
                            border-radius: 50%;
                            animation: pulse 1.5s infinite;
                        "></div>
                        <div style="
                            width: 8px; height: 8px;
                            background: #667eea;
                            border-radius: 50%;
                            animation: pulse 1.5s infinite 0.2s;
                        "></div>
                        <div style="
                            width: 8px; height: 8px;
                            background: #667eea;
                            border-radius: 50%;
                            animation: pulse 1.5s infinite 0.4s;
                        "></div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div style="
                        background: ${isUser ? '#667eea' : 'white'};
                        color: ${isUser ? 'white' : '#333'};
                        border-radius: 18px;
                        padding: 12px 16px;
                        max-width: 80%;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        line-height: 1.5;
                        word-wrap: break-word;
                        position: relative;
                    ">
                        <div class="message-content">${content}</div>
                        ${!isUser ? `
                            <div style="
                                display: flex;
                                gap: 6px;
                                margin-top: 8px;
                                padding-top: 8px;
                                border-top: 1px solid #f0f0f0;
                                justify-content: flex-start;
                            ">
                                <button onclick="regenerateResponse('${messageId}')" style="
                                    background: none;
                                    border: 1px solid #e5e5e5;
                                    border-radius: 12px;
                                    padding: 3px 8px;
                                    font-size: 11px;
                                    color: #666;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 3px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                                </button>
                                <button onclick="speakMessage('${messageId}')" style="
                                    background: none;
                                    border: 1px solid #e5e5e5;
                                    border-radius: 12px;
                                    padding: 3px 8px;
                                    font-size: 11px;
                                    color: #666;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 3px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                    ğŸ”Š æœ—è¯»
                                </button>
                                <button onclick="deleteMessage('${messageId}')" style="
                                    background: none;
                                    border: 1px solid #ffebee;
                                    border-radius: 12px;
                                    padding: 3px 8px;
                                    font-size: 11px;
                                    color: #f44336;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 3px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='none'">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        // ç§»é™¤æ¶ˆæ¯
        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        // é‡æ–°ç”Ÿæˆå›å¤
        async function regenerateResponse(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const config = window.currentChatConfig;
            if (!config || !config.chatHistory.length) {
                alert('æ— æ³•é‡æ–°ç”Ÿæˆï¼Œå¯¹è¯å†å²ä¸ºç©º');
                return;
            }
            
            // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
            const lastUserMessage = config.chatHistory
                .slice()
                .reverse()
                .find(msg => msg.role === 'user');
                
            if (!lastUserMessage) {
                alert('æ‰¾ä¸åˆ°ç”¨æˆ·æ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ');
                return;
            }
            
            // æ˜¾ç¤ºé‡æ–°ç”ŸæˆçŠ¶æ€
            const contentDiv = messageElement.querySelector('.message-content');
            const originalContent = contentDiv.innerHTML;
            contentDiv.innerHTML = 'ğŸ”„ æ­£åœ¨é‡æ–°ç”Ÿæˆ...';
            
            try {
                // è°ƒç”¨APIé‡æ–°ç”Ÿæˆ
                const response = await callCozeAPI(lastUserMessage.content, config);
                contentDiv.innerHTML = response.text;
                
                // ğŸµ å°è¯•ä¸ºé‡æ–°ç”Ÿæˆçš„æ¶ˆæ¯ç”ŸæˆCoze TTSéŸ³é¢‘
                tryGenerateCozeAudio(messageId, response.text);
                
                console.log('âœ… æ¶ˆæ¯é‡æ–°ç”Ÿæˆå®Œæˆ');
                
                // ğŸ“ æ›´æ–°èŠå¤©å†å²ä¸­çš„æœ€åä¸€æ¡åŠ©æ‰‹å›å¤
                const lastAssistantIndex = config.chatHistory.map((msg, index) => ({msg, index}))
                    .reverse()
                    .find(item => item.msg.role === 'assistant')?.index;
                    
                if (lastAssistantIndex !== undefined) {
                    config.chatHistory[lastAssistantIndex].content = response.text;
                    console.log('âœ… å·²æ›´æ–°èŠå¤©å†å²');
                }
                
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                contentDiv.innerHTML = originalContent;
                alert('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // è¯­éŸ³æ’­æ”¾åŠŸèƒ½
        function speakMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            const contentDiv = messageElement.querySelector('.message-content');
            const text = contentDiv.textContent || contentDiv.innerText;
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
            if (!('speechSynthesis' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½');
                return;
            }
            
            // åœæ­¢å½“å‰æ’­æ”¾
            speechSynthesis.cancel();
            
            // åˆ›å»ºè¯­éŸ³åˆæˆå¯¹è±¡
            const utterance = new SpeechSynthesisUtterance(text);
            
            // ğŸ­ æ ¹æ®è§’è‰²è®¾ç½®ä¸“å±è¯­éŸ³å‚æ•°
            const voiceSettings = getCharacterVoiceSettings();
            utterance.lang = 'zh-CN'; // ä¸­æ–‡
            utterance.rate = voiceSettings.rate; // è§’è‰²ä¸“å±è¯­é€Ÿ
            utterance.pitch = voiceSettings.pitch; // è§’è‰²ä¸“å±éŸ³è°ƒ
            utterance.volume = voiceSettings.volume; // éŸ³é‡
            
            // ğŸµ æ™ºèƒ½é€‰æ‹©æœ€ä½³ä¸­æ–‡è¯­éŸ³
            const voices = speechSynthesis.getVoices();
            const chineseVoices = voices.filter(voice => 
                voice.lang.includes('zh') || voice.lang.includes('CN') || voice.lang.includes('Chinese')
            );
            
            if (chineseVoices.length > 0) {
                // æ™ºèƒ½è¯­éŸ³é€‰æ‹©ç­–ç•¥
                let selectedVoice = null;
                
                if (voiceSettings.preferMale) {
                    // ç”·å£°ä¼˜å…ˆçº§ï¼šæ˜ç¡®ç”·å£° > éå¥³å£° > é»˜è®¤
                    selectedVoice = chineseVoices.find(voice => 
                        voice.name.includes('Male') || voice.name.includes('ç”·') || voice.name.includes('Male')
                    ) || chineseVoices.find(voice => 
                        !voice.name.includes('Female') && !voice.name.includes('å¥³')
                    ) || chineseVoices[0];
                } else {
                    // å¥³å£°ä¼˜å…ˆçº§
                    selectedVoice = chineseVoices.find(voice => 
                        voice.name.includes('Female') || voice.name.includes('å¥³')
                    ) || chineseVoices[0];
                }
                
                utterance.voice = selectedVoice;
                console.log(`ğŸ­ ${currentCharacter?.name || 'è§’è‰²'} ä½¿ç”¨è¯­éŸ³: ${selectedVoice.name} (${selectedVoice.lang})`);
                console.log(`ğŸµ è¯­éŸ³è®¾ç½®: è¯­é€Ÿ${voiceSettings.rate} éŸ³è°ƒ${voiceSettings.pitch} - ${voiceSettings.description}`);
            } else {
                console.log('âš ï¸ æœªæ‰¾åˆ°ä¸­æ–‡è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤è¯­éŸ³');
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œè§†è§‰æ•ˆæœ
            const button = messageElement.querySelector('button[onclick*="speakMessage"]');
            const originalText = button.innerHTML;
            const originalStyle = button.style.cssText;
            
            button.innerHTML = 'â¸ï¸ åœæ­¢æœ—è¯»';
            button.style.background = '#dc3545';
            button.style.color = 'white';
            button.onclick = function() {
                speechSynthesis.cancel();
                button.innerHTML = originalText;
                button.style.cssText = originalStyle;
                button.onclick = function() { speakMessage(messageId); };
            };
            
            // æ’­æ”¾å¼€å§‹æ—¶çš„è§†è§‰åé¦ˆ
            utterance.onstart = function() {
                console.log(`ğŸ­ å¼€å§‹æœ—è¯» ${currentCharacter?.name || 'è§’è‰²'} çš„å›ç­”`);
                button.style.animation = 'pulse 1.5s infinite';
            };
            
            // æ’­æ”¾å®Œæˆåæ¢å¤æŒ‰é’®
            utterance.onend = function() {
                button.innerHTML = originalText;
                button.style.cssText = originalStyle;
                button.onclick = function() { speakMessage(messageId); };
                console.log('ğŸµ æœ—è¯»å®Œæˆ');
            };
            
            // æ’­æ”¾é”™è¯¯æ—¶æ¢å¤æŒ‰é’®
            utterance.onerror = function(event) {
                console.error('ğŸµ æœ—è¯»å¤±è´¥:', event.error);
                button.innerHTML = originalText;
                button.style.cssText = originalStyle;
                button.onclick = function() { speakMessage(messageId); };
            };
            
            // å¼€å§‹æ’­æ”¾
            speechSynthesis.speak(utterance);
        }

        // åˆ é™¤æ¶ˆæ¯
        function deleteMessage(messageId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    // æ·»åŠ åˆ é™¤åŠ¨ç”»
                    messageElement.style.transition = 'opacity 0.3s, transform 0.3s';
                    messageElement.style.opacity = '0';
                    messageElement.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        messageElement.remove();
                        
                        // ä»å¯¹è¯å†å²ä¸­åˆ é™¤å¯¹åº”æ¶ˆæ¯
                        const config = window.currentChatConfig;
                        if (config && config.chatHistory) {
                            // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦å®ç°æ›´ç²¾ç¡®çš„å†å²è®°å½•æ¸…ç†
                            console.log('æ¶ˆæ¯å·²åˆ é™¤:', messageId);
                        }
                    }, 300);
                }
            }
        }

        // ğŸµ è°ƒç”¨Coze TTS APIç”Ÿæˆæ™ºèƒ½ä½“éŸ³é¢‘ - å¤šç«¯ç‚¹å°è¯•
        async function generateCozeAudio(text, voiceId, apiKey) {
            console.log(`ğŸµ å¼€å§‹è°ƒç”¨Coze TTS APIï¼Œè¯­éŸ³ID: ${voiceId}`);
            console.log(`ğŸµ æ–‡æœ¬å†…å®¹: ${text}`);

            // å®šä¹‰å¤šä¸ªå¯èƒ½çš„ç«¯ç‚¹å’Œå‚æ•°ç»„åˆ
            const endpoints = [
                {
                    url: 'https://api.coze.cn/open_api/v2/audio/speech',
                    params: {
                        voice_id: voiceId,
                        text: text,
                        format: 'mp3',
                        speed: 1.0
                    }
                },
                {
                    url: 'https://api.coze.cn/open_api/v2/text_to_speech',
                    params: {
                        voice_id: voiceId,
                        text: text,
                        format: 'mp3',
                        speed: 1.0,
                        volume: 1.0
                    }
                },
                {
                    url: 'https://api.coze.cn/v1/text_to_speech',
                    params: {
                        voice_id: voiceId,
                        input: text,
                        response_format: 'mp3'
                    }
                },
                {
                    url: 'https://api.coze.cn/api/v2/text_to_speech',
                    params: {
                        bot_id: '7534668235225219091', // æç™½çš„Bot ID
                        voice_id: voiceId,
                        text: text,
                        audio_format: 'mp3'
                    }
                }
            ];

            // é€ä¸€å°è¯•æ¯ä¸ªç«¯ç‚¹
            for (let i = 0; i < endpoints.length; i++) {
                const endpoint = endpoints[i];
                console.log(`ğŸ” å°è¯•ç«¯ç‚¹ ${i + 1}/${endpoints.length}: ${endpoint.url}`);

                try {
                    const response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(endpoint.params)
                    });

                    console.log(`ğŸ“¡ ç«¯ç‚¹ ${i + 1} å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        
                        // æ£€æŸ¥æ˜¯å¦è¿”å›éŸ³é¢‘æ–‡ä»¶
                        if (contentType && contentType.includes('audio/')) {
                            console.log('âœ… è·å¾—éŸ³é¢‘æ–‡ä»¶å“åº”');
                            const audioBlob = await response.blob();
                            const audioUrl = URL.createObjectURL(audioBlob);
                            
                            return {
                                success: true,
                                audioUrl: audioUrl,
                                audioData: { size: audioBlob.size, type: contentType },
                                endpoint: endpoint.url
                            };
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦è¿”å›JSONæ ¼å¼çš„éŸ³é¢‘URL
                        try {
                            const data = await response.json();
                            console.log(`ğŸ“„ ç«¯ç‚¹ ${i + 1} JSONå“åº”:`, data);

                            // æ£€æŸ¥å¤šç§å¯èƒ½çš„éŸ³é¢‘URLå­—æ®µ
                            const audioUrl = data.audio_url || 
                                           data.data?.audio_url || 
                                           data.result?.audio_url ||
                                           data.url;

                            if (audioUrl) {
                                console.log('âœ… åœ¨JSONå“åº”ä¸­æ‰¾åˆ°éŸ³é¢‘URL');
                                return {
                                    success: true,
                                    audioUrl: audioUrl,
                                    audioData: data,
                                    endpoint: endpoint.url
                                };
                            }

                            if (data.code === 0) {
                                console.log('âš ï¸ APIè°ƒç”¨æˆåŠŸä½†æœªæ‰¾åˆ°éŸ³é¢‘æ•°æ®');
                            } else {
                                console.log(`âŒ APIè¿”å›é”™è¯¯: ${data.code} - ${data.msg || data.message}`);
                            }
                        } catch (e) {
                            console.log('âš ï¸ å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼');
                        }
                    } else {
                        // è®°å½•é”™è¯¯ä½†ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªç«¯ç‚¹
                        try {
                            const errorData = await response.json();
                            console.log(`âŒ ç«¯ç‚¹ ${i + 1} é”™è¯¯:`, errorData);
                        } catch (e) {
                            const errorText = await response.text();
                            console.log(`âŒ ç«¯ç‚¹ ${i + 1} é”™è¯¯: ${errorText}`);
                        }
                    }

                } catch (error) {
                    console.log(`âŒ ç«¯ç‚¹ ${i + 1} è¯·æ±‚å¤±è´¥: ${error.message}`);
                }
            }

            // æ‰€æœ‰ç«¯ç‚¹éƒ½å¤±è´¥
            console.error('âŒ æ‰€æœ‰TTSç«¯ç‚¹éƒ½å¤±è´¥ï¼Œå›é€€åˆ°æµè§ˆå™¨TTS');
            return {
                success: false,
                error: 'æ‰€æœ‰Coze TTSç«¯ç‚¹éƒ½ä¸å¯ç”¨',
                fallbackTTS: true
            };
        }

        // ğŸ”Š ä¸ºæ¶ˆæ¯æ·»åŠ æ™ºèƒ½ä½“éŸ³é¢‘åŠŸèƒ½
        async function addCozeAudioToMessage(messageId, text) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) {
                console.warn('æ‰¾ä¸åˆ°æ¶ˆæ¯å…ƒç´ :', messageId);
                return;
            }

            const messageActions = messageElement.querySelector('.message-actions');
            if (!messageActions) {
                console.warn('æ‰¾ä¸åˆ°æ¶ˆæ¯æ“ä½œåŒºåŸŸ');
                return;
            }

            // è·å–å½“å‰è§’è‰²çš„è¯­éŸ³é…ç½®
            const voiceId = getCurrentCharacterVoiceId();
            if (!voiceId) {
                console.log('âš ï¸ å½“å‰è§’è‰²æœªé…ç½®Cozeè¯­éŸ³IDï¼Œè·³è¿‡TTSç”Ÿæˆ');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ™ºèƒ½ä½“éŸ³é¢‘æŒ‰é’®
            const existingAudioBtn = messageActions.querySelector('.coze-audio-btn');
            if (existingAudioBtn) {
                existingAudioBtn.remove();
            }

            // åˆ›å»ºæ™ºèƒ½ä½“éŸ³é¢‘æŒ‰é’®
            const audioBtn = document.createElement('button');
            audioBtn.className = 'action-btn coze-audio-btn';
            audioBtn.innerHTML = 'ğŸµ æ‰£å­éŸ³è‰²';
            audioBtn.title = 'æ’­æ”¾æ™ºèƒ½ä½“åŸç”ŸéŸ³è‰²';
            audioBtn.disabled = true; // åˆå§‹ç¦ç”¨ï¼Œç”Ÿæˆå®Œæˆåå¯ç”¨
            
            // æ’å…¥åˆ°ç¬¬ä¸€ä¸ªä½ç½®
            const readBtn = messageActions.querySelector('[onclick*="speakMessage"]');
            if (readBtn) {
                messageActions.insertBefore(audioBtn, readBtn);
            } else {
                messageActions.appendChild(audioBtn);
            }

            // å¼‚æ­¥ç”ŸæˆéŸ³é¢‘
            audioBtn.innerHTML = 'â³ ç”Ÿæˆä¸­...';
            
            const config = getCurrentConfig();
            const audioResult = await generateCozeAudio(text, voiceId, config.apiKey);
            
            if (audioResult.success && audioResult.audioUrl) {
                audioBtn.innerHTML = 'ğŸµ æ‰£å­éŸ³è‰²';
                audioBtn.disabled = false;
                audioBtn.onclick = function() {
                    playCozeAudio(audioResult.audioUrl, audioBtn);
                };
                console.log('âœ… æ™ºèƒ½ä½“éŸ³é¢‘ç”ŸæˆæˆåŠŸ');
            } else {
                audioBtn.innerHTML = 'âŒ ç”Ÿæˆå¤±è´¥';
                audioBtn.disabled = true;
                audioBtn.title = `ç”Ÿæˆå¤±è´¥: ${audioResult.error}`;
                console.error('âŒ æ™ºèƒ½ä½“éŸ³é¢‘ç”Ÿæˆå¤±è´¥:', audioResult.error);
            }
        }

        // ğŸµ è·å–å½“å‰è§’è‰²çš„Cozeè¯­éŸ³ID
        function getCurrentCharacterVoiceId() {
            if (!currentCharacter) return null;

            // ä»localStorageè·å–è§’è‰²çš„è¯­éŸ³é…ç½®
            const voiceMap = JSON.parse(localStorage.getItem('character_voice_map') || '{}');
            return voiceMap[currentCharacter.id] || getDefaultVoiceId(currentCharacter.id);
        }

        // ğŸ­ è·å–è§’è‰²é»˜è®¤è¯­éŸ³IDï¼ˆåŸºäºä¹‹å‰æ£€æµ‹åˆ°çš„é…ç½®ï¼‰
        function getDefaultVoiceId(characterId) {
            const defaultVoices = {
                'libai': '7481299960424579126', // ä»ä½ çš„é…ç½®æ£€æµ‹ç»“æœä¸­è·å¾—
                // å…¶ä»–è§’è‰²å¯ä»¥é…ç½®ç›¸åŒæˆ–ä¸åŒçš„è¯­éŸ³ID
            };
            return defaultVoices[characterId] || '7481299960424579126';
        }

        // ğŸµ æ’­æ”¾Cozeæ™ºèƒ½ä½“éŸ³é¢‘
        function playCozeAudio(audioUrl, buttonElement) {
            // åœæ­¢å…¶ä»–éŸ³é¢‘
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }

            // åœæ­¢æµè§ˆå™¨TTS
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }

            try {
                console.log('ğŸµ æ’­æ”¾Cozeæ™ºèƒ½ä½“éŸ³é¢‘:', audioUrl);
                const audio = new Audio(audioUrl);
                window.currentAudio = audio;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = 'â¸ï¸ åœæ­¢æ’­æ”¾';
                buttonElement.disabled = false;

                audio.onplay = () => {
                    console.log('âœ… å¼€å§‹æ’­æ”¾Cozeæ™ºèƒ½ä½“éŸ³é¢‘');
                };

                audio.onended = () => {
                    console.log('âœ… Cozeæ™ºèƒ½ä½“éŸ³é¢‘æ’­æ”¾å®Œæˆ');
                    buttonElement.innerHTML = originalText;
                    buttonElement.onclick = () => playCozeAudio(audioUrl, buttonElement);
                    window.currentAudio = null;
                };

                audio.onerror = (error) => {
                    console.error('âŒ Cozeæ™ºèƒ½ä½“éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                    buttonElement.innerHTML = originalText;
                    buttonElement.onclick = () => playCozeAudio(audioUrl, buttonElement);
                    window.currentAudio = null;
                    showNotification('æ™ºèƒ½ä½“éŸ³é¢‘æ’­æ”¾å¤±è´¥');
                };

                // ç‚¹å‡»åœæ­¢æ’­æ”¾
                buttonElement.onclick = function() {
                    audio.pause();
                    buttonElement.innerHTML = originalText;
                    buttonElement.onclick = () => playCozeAudio(audioUrl, buttonElement);
                    window.currentAudio = null;
                };

                audio.play();

            } catch (error) {
                console.error('âŒ åˆ›å»ºCozeéŸ³é¢‘å¤±è´¥:', error);
                showNotification('éŸ³é¢‘æ’­æ”¾å¤±è´¥');
            }
        }

        // ğŸ” è·å–æ™ºèƒ½ä½“é…ç½®ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
        async function getBotConfigInfo() {
            if (!currentCharacter) {
                console.log('âŒ å½“å‰æ²¡æœ‰é€‰æ‹©è§’è‰²');
                return;
            }

            const apiKey = localStorage.getItem('coze_api_key');
            const botMap = JSON.parse(localStorage.getItem('bot_map') || '{}');
            const botId = botMap[currentCharacter.id] || currentCharacter.botId;

            if (!apiKey || !botId) {
                console.log('âŒ ç¼ºå°‘APIé…ç½®');
                return;
            }

            try {
                console.log(`ğŸ” è·å– ${currentCharacter.name} çš„é…ç½®ä¿¡æ¯...`);
                
                const response = await fetch(`https://api.coze.cn/open_api/v2/bots/${botId}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                console.log('ğŸ¤– æ™ºèƒ½ä½“å®Œæ•´é…ç½®:', result);

                if (result.code === 0 && result.data) {
                    const config = result.data;
                    console.log('ğŸ“Š é…ç½®åˆ†æ:', {
                        name: config.name,
                        hasVoice: !!(config.voice_setting && Object.keys(config.voice_setting).length > 0),
                        voiceConfig: config.voice_setting,
                        pluginCount: config.plugin_info_list ? config.plugin_info_list.length : 0,
                        plugins: config.plugin_info_list,
                        model: config.model_info?.model_name
                    });
                }

            } catch (error) {
                console.error('âŒ è·å–é…ç½®å¤±è´¥:', error);
            }
        }

        // ğŸ­ è·å–è§’è‰²ä¸“å±è¯­éŸ³è®¾ç½®
        function getCharacterVoiceSettings() {
            if (!currentCharacter) {
                return { rate: 0.8, pitch: 1.0, volume: 1.0, preferMale: true };
            }
            
            const voiceProfiles = {
                'libai': {
                    rate: 0.85,      // ç•¥æ…¢ï¼Œä½“ç°è¯—äººçš„åŸè¯µæ„Ÿ
                    pitch: 1.2,      // ç•¥é«˜ï¼Œä½“ç°è±ªæ”¾æ°”è´¨
                    volume: 1.0,
                    preferMale: true,
                    description: 'è±ªæ”¾è¯—äººéŸ³è‰²'
                },
                'luxun': {
                    rate: 0.7,       // è¾ƒæ…¢ï¼Œä½“ç°æ·±æ²‰æ€è€ƒ
                    pitch: 0.9,      // ç•¥ä½ï¼Œä½“ç°ä¸¥è‚ƒ
                    volume: 1.0,
                    preferMale: true,
                    description: 'æ–‡å­¦å®¶éŸ³è‰²'
                },
                'edison': {
                    rate: 0.8,       // ä¸­ç­‰è¯­é€Ÿ
                    pitch: 1.1,      // ç•¥é«˜ï¼Œä½“ç°å‘æ˜å®¶çš„æ´»åŠ›
                    volume: 1.0,
                    preferMale: true,
                    description: 'å‘æ˜å®¶éŸ³è‰²'
                },
                'faraday': {
                    rate: 0.75,      // ç•¥æ…¢ï¼Œä½“ç°ç§‘å­¦å®¶çš„ä¸¥è°¨
                    pitch: 1.0,      // æ ‡å‡†éŸ³è°ƒ
                    volume: 1.0,
                    preferMale: true,
                    description: 'ç§‘å­¦å®¶éŸ³è‰²'
                },
                'luobinwang': {
                    rate: 0.9,       // ç¨å¿«ï¼Œä½“ç°å„¿ç«¥è¯—äººçš„æ´»æ³¼
                    pitch: 1.3,      // è¾ƒé«˜ï¼Œä½“ç°å¹´è½»
                    volume: 1.0,
                    preferMale: true,
                    description: 'å°‘å¹´è¯—äººéŸ³è‰²'
                },
                'wangwei': {
                    rate: 0.75,      // æ…¢é€Ÿï¼Œä½“ç°å±±æ°´è¯—äººçš„å®é™
                    pitch: 1.1,      // ç•¥é«˜ï¼Œä½“ç°æ¸…é›…
                    volume: 1.0,
                    preferMale: true,
                    description: 'å±±æ°´è¯—äººéŸ³è‰²'
                }
            };
            
            const profile = voiceProfiles[currentCharacter.id] || {
                rate: 0.8, pitch: 1.0, volume: 1.0, preferMale: true, description: 'é»˜è®¤éŸ³è‰²'
            };
            
            console.log(`ğŸ­ ${currentCharacter.name} ä½¿ç”¨: ${profile.description}`);
            return profile;
        }

        // ğŸµ å°è¯•ç”ŸæˆCozeéŸ³é¢‘ï¼ˆç®€åŒ–è°ƒç”¨ï¼‰
        async function tryGenerateCozeAudio(messageId, text) {
            if (!currentCharacter) {
                console.log('âš ï¸ å½“å‰æ²¡æœ‰è§’è‰²ï¼Œè·³è¿‡Coze TTS');
                return;
            }

            const config = getCurrentConfig();
            if (!config || !config.apiKey) {
                console.log('âš ï¸ æ²¡æœ‰APIé…ç½®ï¼Œè·³è¿‡Coze TTS');
                return;
            }

            // è·å–è¯­éŸ³ID
            const voiceId = getCurrentCharacterVoiceId();
            if (!voiceId) {
                console.log(`âš ï¸ ${currentCharacter.name}æœªé…ç½®è¯­éŸ³IDï¼Œè·³è¿‡Coze TTS`);
                return;
            }

            console.log(`ğŸµ å¼€å§‹ä¸º${currentCharacter.name}ç”ŸæˆCozeéŸ³è‰²...`);

            try {
                const result = await generateCozeAudio(text, voiceId, config.apiKey);
                
                if (result.success) {
                    console.log(`âœ… Coze TTSæˆåŠŸï¼ä½¿ç”¨ç«¯ç‚¹: ${result.endpoint}`);
                    addCozeAudioButton(messageId, result.audioUrl);
                } else if (result.fallbackTTS) {
                    console.log('â„¹ï¸ Coze TTSä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨å¢å¼ºçš„æµè§ˆå™¨TTS');
                } else {
                    console.log(`âŒ Coze TTSå¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                console.error('âŒ Coze TTSè°ƒç”¨å¼‚å¸¸:', error);
            }
        }

        // ğŸµ ä¸ºæ¶ˆæ¯æ·»åŠ CozeéŸ³é¢‘æŒ‰é’®
        function addCozeAudioButton(messageId, audioUrl) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;

            const messageActions = messageElement.querySelector('.message-actions');
            if (!messageActions) return;

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰CozeéŸ³é¢‘æŒ‰é’®
            const existingBtn = messageActions.querySelector('.coze-audio-btn');
            if (existingBtn) {
                existingBtn.remove();
            }

            // åˆ›å»ºCozeéŸ³é¢‘æŒ‰é’®
            const audioBtn = document.createElement('button');
            audioBtn.className = 'action-btn coze-audio-btn';
            audioBtn.innerHTML = 'ğŸ­ æ‰£å­åŸå£°';
            audioBtn.title = 'æ’­æ”¾æ™ºèƒ½ä½“åŸç”ŸéŸ³è‰²';
            audioBtn.style.background = '#28a745';
            audioBtn.style.color = 'white';
            
            audioBtn.onclick = function() {
                playCozeAudio(audioUrl, audioBtn);
            };

            // æ’å…¥åˆ°æœ—è¯»æŒ‰é’®ä¹‹å‰
            const readBtn = messageActions.querySelector('[onclick*="speakMessage"]');
            if (readBtn) {
                messageActions.insertBefore(audioBtn, readBtn);
            } else {
                messageActions.appendChild(audioBtn);
            }

            console.log('âœ… å·²æ·»åŠ CozeéŸ³é¢‘æŒ‰é’®');
        }

        // ç®€å•çš„é€šçŸ¥å‡½æ•°
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„é€šçŸ¥UIï¼Œç›®å‰ä½¿ç”¨consoleè¾“å‡º
        }

        // å°†å‡½æ•°ç»‘å®šåˆ°å…¨å±€å¯¹è±¡ï¼Œç¡®ä¿HTML onclickèƒ½è®¿é—®åˆ°
        window.regenerateResponse = regenerateResponse;
        window.speakMessage = speakMessage;
        window.deleteMessage = deleteMessage;
        window.sendPresetQuestion = sendPresetQuestion;
        window.getBotConfigInfo = getBotConfigInfo;

        // è°ƒç”¨ Coze API
        async function callCozeAPI(message, config) {
            const apiUrl = 'https://api.coze.cn/open_api/v2/chat';
            
            const requestBody = {
                bot_id: config.botId,
                user: config.sessionId,
                query: message,
                chat_history: config.chatHistory.slice(-6), // ä¿ç•™æœ€è¿‘6æ¡å¯¹è¯
                stream: false, // ç”¨æˆ·ç‰ˆæœ¬ä½¿ç”¨éæµå¼ä»¥ä¿è¯ç¨³å®šæ€§
                auto_save_history: true, // è‡ªåŠ¨ä¿å­˜å†å²
                meta_data: {}, // å…ƒæ•°æ®é…ç½®
                // ğŸµ å°è¯•è¯·æ±‚éŸ³é¢‘è¾“å‡º
                enable_voice: true,
                voice_output: true,
                audio_format: "mp3"
            };

            if (config.conversationId) {
                requestBody.conversation_id = config.conversationId;
            }

            console.log('å‘é€APIè¯·æ±‚:', requestBody);

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${config.apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            console.log('ğŸ” å®Œæ•´APIå“åº”æ•°æ®:', data);
            
            if (data.code !== 0) {
                throw new Error(`APIé”™è¯¯: ${data.msg}`);
            }

            // ğŸ”Š æ£€æŸ¥éŸ³é¢‘ä¿¡æ¯
            let audioData = null;
            if (data.messages) {
                data.messages.forEach(msg => {
                    if (msg.content_type === 'audio' || msg.audio_url) {
                        console.log('ğŸ”Š å‘ç°éŸ³é¢‘ä¿¡æ¯:', msg);
                        audioData = {
                            url: msg.audio_url,
                            type: msg.content_type,
                            duration: msg.duration || null
                        };
                    }
                });
            }

            if (audioData) {
                console.log('âœ… æ™ºèƒ½ä½“è¿”å›äº†éŸ³é¢‘æ•°æ®:', audioData);
            } else {
                console.log('âš ï¸ æ™ºèƒ½ä½“æœªè¿”å›éŸ³é¢‘æ•°æ®ï¼Œå°†ä½¿ç”¨æµè§ˆå™¨TTS');
            }

            // æå–å›å¤å†…å®¹ - å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
            let replyContent = '';
            
            if (data.messages && data.messages.length > 0) {
                // æŸ¥æ‰¾æœ€åä¸€æ¡ assistant æ¶ˆæ¯
                const assistantMessages = data.messages.filter(msg => 
                    msg.role === 'assistant' && msg.type === 'answer'
                );
                
                if (assistantMessages.length > 0) {
                    const lastMessage = assistantMessages[assistantMessages.length - 1];
                    replyContent = lastMessage.content;
                } else {
                    // å¦‚æœæ²¡æœ‰ answer ç±»å‹ï¼Œå–æœ€åä¸€æ¡ assistant æ¶ˆæ¯
                    const allAssistantMessages = data.messages.filter(msg => msg.role === 'assistant');
                    if (allAssistantMessages.length > 0) {
                        replyContent = allAssistantMessages[allAssistantMessages.length - 1].content;
                    }
                }
            }

            // æ¸…ç†å¯èƒ½çš„JSONæ ¼å¼é”™è¯¯
            if (replyContent && typeof replyContent === 'string') {
                // ç§»é™¤å¯èƒ½çš„JSONå‰ç¼€
                replyContent = replyContent.replace(/^\{"msg_type"[^}]+\}/, '').trim();
                // ç§»é™¤å…¶ä»–å¯èƒ½çš„æ ¼å¼é—®é¢˜
                replyContent = replyContent.replace(/^[^a-zA-Z\u4e00-\u9fa5]*/, '').trim();
            }

            // å¦‚æœä»ç„¶æ²¡æœ‰æœ‰æ•ˆå†…å®¹ï¼Œä½¿ç”¨é»˜è®¤å›å¤
            if (!replyContent) {
                replyContent = 'æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰ç†è§£ä½ çš„é—®é¢˜ï¼Œè¯·å†è¯•ä¸€æ¬¡ã€‚';
            }

            // æå–follow_upå»ºè®®é—®é¢˜
            let followUps = [];
            if (data.messages && Array.isArray(data.messages)) {
                followUps = data.messages
                    .filter(m => m.role === 'assistant' && m.type === 'follow_up' && m.content)
                    .map(m => m.content)
                    .filter(Boolean);
            }

            // æ›´æ–°å¯¹è¯å†å²
            config.conversationId = data.conversation_id;
            config.chatHistory.push(
                { role: 'user', content: message },
                { role: 'assistant', content: replyContent }
            );

            console.log('å¤„ç†åçš„å›å¤:', replyContent);
            
            // è¿”å›åŒ…å«æ–‡æœ¬ã€éŸ³é¢‘ä¸å»ºè®®é—®é¢˜çš„å¯¹è±¡
            return {
                text: replyContent,
                audio: audioData,
                conversationId: data.conversation_id,
                hasAudio: !!audioData,
                suggestions: Array.from(new Set(followUps)).slice(0, 3)
            };
        }

        // æ›´æ–°èŠå¤©é¡µé¢è§’è‰²ä¿¡æ¯
        function updateChatPageInfo(celebrity) {
            document.getElementById('current-char-name').textContent = celebrity.name;
            document.getElementById('current-char-period').textContent = celebrity.period;
            
            const avatarImg = document.getElementById('current-char-avatar');
            avatarImg.src = celebrity.avatar;
            avatarImg.onerror = () => avatarImg.src = 'images/default-avatar.jpg';
            
            document.title = `ä¸${celebrity.name}å¯¹è¯ä¸­...`;
        }

        // æ˜¾ç¤ºèŠå¤©é¡µé¢
        function showChatPage() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-page').style.display = 'block';
        }

        // æ˜¾ç¤ºé¦–é¡µ
        function showHomePage() {
            document.getElementById('chat-page').style.display = 'none';
            document.getElementById('home-page').style.display = 'flex';
            
            // æ¸…ç†èŠå¤©å®¢æˆ·ç«¯
            if (currentChatClient) {
                currentChatClient.destroy && currentChatClient.destroy();
                currentChatClient = null;
            }
            
            document.title = 'åäººæ™ºèƒ½ä½“å¯¹è¯';
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            document.getElementById('back-btn').onclick = showHomePage;
        }
    </script>
</body>
</html> 